# db push через SSH-туннель (пошагово)

Инструкция: как с домашнего ПК выполнять `npx prisma db push` и другие команды Prisma к Postgres на VPS (Supabase в Dokploy).

**Требования:** на VPS уже настроен проброс порта Postgres (см. `docs/supabase-vps-postgres.md`), в `.env` указан `DATABASE_URL` с хостом `127.0.0.1` и портом `5433`.

---

## Часть 1. Один раз: SSH-ключ и доступ на сервер

Делается один раз. После этого пароль для туннеля не нужен.

### 1.1. На твоём ПК (Windows): создать ключ

Открой **CMD** (или PowerShell) и выполни:

```cmd
mkdir %USERPROFILE%\.ssh 2>nul
ssh-keygen -t ed25519 -f %USERPROFILE%\.ssh\vps_pulse -N ""
```

На вопрос про passphrase ничего не вводи — просто Enter (мы уже указали пустой пароль через `-N ""`).

Должно появиться сообщение вроде:
`Your identification has been saved in C:\Users\ТВОЙ_ЛОГИН\.ssh\vps_pulse`

### 1.2. Узнать свой публичный ключ

В том же CMD:

```cmd
type %USERPROFILE%\.ssh\vps_pulse.pub
```

Скопируй **всю строку** (начинается с `ssh-ed25519`, заканчивается `nikita@DESKTOP-...` или твоим хостом). Она понадобится на сервере.

### 1.3. На сервере: добавить ключ в authorized_keys

1. Подключись к VPS через **Termius** (или любой SSH-клиент) к хосту **155.212.147.165**, пользователь **root**, пароль как обычно.
2. В **терминале Termius** (уже на сервере, приглашение вроде `root@poxqteanmt:~#`) вставь одну команду, **подставив вместо `ТВОЯ_СТРОКА_ИЗ_ШАГА_1.2`** скопированную строку из `vps_pulse.pub`:

```bash
mkdir -p ~/.ssh && chmod 700 ~/.ssh && echo "ТВОЯ_СТРОКА_ИЗ_ШАГА_1.2" >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys
```

Пример (подставь свою строку из шага 1.2):

```bash
mkdir -p ~/.ssh && chmod 700 ~/.ssh && echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI... nikita@DESKTOP-8V2GTNG" >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys
```

3. Готово. Больше на сервере ничего для ключа делать не нужно.

### 1.4. Проверка с ПК

На ПК в CMD выполни:

```cmd
ssh -i %USERPROFILE%\.ssh\vps_pulse root@155.212.147.165
```

Должно войти **без запроса пароля**. Если вошёл — выйди (`exit`) и переходи к части 2.

---

## Часть 2. Каждый раз: туннель и db push

Когда нужно выполнить `db push`, миграции или другие команды Prisma к удалённой БД.

### 2.1. Поднять туннель (первое окно CMD)

На ПК открой **CMD** и выполни:

```cmd
ssh -i %USERPROFILE%\.ssh\vps_pulse -L 5433:127.0.0.1:5434 root@155.212.147.165
```

- Пароль не должен спрашиваться (если часть 1 сделана).
- Окно **не закрывай** — пока эта команда работает, туннель активен.
- Оставь это окно открытым и переходи к шагу 2.2.

Что делает команда: на твоём ПК порт **5433** пробрасывается на порт **5434** на VPS (там слушает Postgres). В `.env` у тебя `DATABASE_URL` с портом **5433** — Prisma стучится на свой localhost:5433 и попадает в БД на VPS.

### 2.2. Выполнить Prisma (второе окно CMD)

Открой **второе** окно CMD, перейди в папку проекта и выполни нужную команду, например:

```cmd
cd D:\pulse
npx prisma db push
```

Или:

```cmd
cd D:\pulse
npx prisma migrate dev
```

Или любую другую команду Prisma — пока туннель из шага 2.1 открыт, подключение к БД будет работать.

### 2.3. После работы

Когда закончил с Prisma, в первом окне (где висит `ssh -i ...`) можно нажать **Ctrl+C** и закрыть его — туннель завершится.

---

## Кратко (после однократной настройки ключа)

1. **Окно 1 (CMD):**  
   `ssh -i %USERPROFILE%\.ssh\vps_pulse -L 5433:127.0.0.1:5434 root@155.212.147.165`  
   Не закрывать.

2. **Окно 2 (CMD):**  
   `cd D:\pulse`  
   `npx prisma db push` (или другая команда Prisma).

3. По желанию закрыть окно 1 через Ctrl+C.

---

## Если что-то не так

| Проблема | Что проверить |
|----------|----------------|
| `Permission denied` при `ssh -i ...` | Ключ добавлен в `authorized_keys` на сервере (часть 1.3)? Строка из `vps_pulse.pub` одна и та же, без переносов? |
| `Can't reach database server at 127.0.0.1:5433` | Туннель из шага 2.1 запущен? Окно с `ssh -i ... -L 5433:...` не закрыто? |
| `Connection refused` на VPS на порту 5434 | На VPS в compose Supabase у сервиса `db` должен быть проброс `127.0.0.1:5434:5432` — см. `docs/supabase-vps-postgres.md`. |
