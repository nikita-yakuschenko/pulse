# Интеграции

В разделе **Настройки → Интеграции** можно подключить внешние системы: 1С, Битрикс24, Telegram.

Настройки интеграций сохраняются в `user_metadata` пользователя Supabase и доступны только владельцу.

---

## 1С

Подключение к базе 1С через HTTP-сервисы на api.module.team.

**Доступные среды:**
- **Тестовая**: `https://api.module.team/module.team/hs/` — для разработки и тестирования
- **Боевая**: `https://api.module.team/main/hs/` — рабочая база

**Настройки:**
- **Среда**: выбор между тестовой и боевой базой
- **Логин**: имя пользователя 1С (может быть на кириллице, например "Иван")
- **Пароль**: пароль пользователя
- **Включить интеграцию**: чекбокс для активации

**Авторизация:**
- Basic Auth с поддержкой UTF-8 (кириллица в логине)
- Логин и пароль кодируются в base64 с учётом кириллицы через TextEncoder

**Проверка подключения:** 
Кнопка «Проверить подключение» отправляет GET-запрос к `{базовый URL}/health/check` с Basic Auth. Если сервер возвращает 200 OK, подключение считается успешным, и credentials сохраняются в `user_metadata`.

**Особенности:**
- Логин может быть написан кириллицей (учтено в реализации)
- Таймаут запроса: 10 секунд
- URL формируется автоматически в зависимости от выбранной среды

---

## Битрикс24

Подключение через входящий вебхук (Incoming Webhook).

**Настройки:**
- **Webhook URL**: полный URL вебхука, например `https://ваш-портал.bitrix24.ru/rest/1/xxxxx/`
- **Включить интеграцию**: чекбокс для активации

**Проверка подключения:** кнопка «Проверить подключение» вызывает метод `app.info` через вебхук. Если Битрикс24 отвечает корректно, подключение успешно.

**Как создать вебхук в Битрикс24:**
1. Открыть портал Битрикс24
2. Приложения → Вебхуки → **Добавить вебхук**
3. Тип: **Входящий вебхук**
4. Права: выбрать нужные (например, CRM, Задачи)
5. Скопировать URL вебхука и вставить в Pulse

---

## Telegram

Подключение бота через Bot API.

**Настройки:**
- **Bot Token**: токен бота из @BotFather, например `110201543:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw`
- **Включить интеграцию**: чекбокс для активации

**Проверка подключения:** кнопка «Проверить бота» вызывает метод `getMe` Telegram Bot API. Если бот доступен, выводится его username (например, `@your_bot`).

**Как создать бота в Telegram:**
1. Открыть @BotFather в Telegram
2. Отправить `/newbot`
3. Указать имя и username бота
4. Скопировать токен и вставить в Pulse

---

## API

### GET /api/integrations/test

**Описание:** проверка подключения к интеграции.

**Параметры (POST JSON):**
```json
{
  "type": "1c" | "bitrix24" | "telegram",
  "settings": { ... }
}
```

**Ответ (200):**
```json
{
  "success": true,
  "message": "Подключение успешно."
}
```

**Ответ (400/500):**
```json
{
  "error": "Описание ошибки"
}
```

**Примеры:**
- **1С**: отправляет GET с Basic Auth
- **Битрикс24**: вызывает `app.info`
- **Telegram**: вызывает `getMe`

---

## Хранение настроек

Настройки интеграций сохраняются в `user_metadata` Supabase:

```json
{
  "integrations": {
    "1c": {
      "environment": "test",
      "username": "Иван",
      "password": "password123",
      "enabled": true
    },
    "bitrix24": {
      "webhookUrl": "https://...",
      "enabled": true
    },
    "telegram": {
      "botToken": "...",
      "enabled": true
    }
  }
}
```

**Безопасность:**
- Credentials хранятся в `user_metadata` Supabase Auth
- ✅ **Encryption at rest** — Supabase шифрует данные автоматически
- ✅ **RLS-защита** — доступ только у владельца аккаунта
- ✅ **HTTPS** для всех запросов
- Готово для production без дополнительных настроек
