Функция GetBalances(Запрос)
	Попытка
		// Параметры из URL: /get/code/{code} и /get/name/{name}
		КодФильтр = "";
		НаименованиеФильтр = "";
		Попытка
			КодФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["code"]));
		Исключение
			КодФильтр = "";
		КонецПопытки;
		Попытка
			НаименованиеФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["name"]));
		Исключение
			НаименованиеФильтр = "";
		КонецПопытки;

		// 1. Номенклатура — только элементы (не группы), как в materials.bsl
		УсловиеГде = "Номенклатура.ПометкаУдаления = ЛОЖЬ И Номенклатура.ЭтоГруппа = ЛОЖЬ";
		Если Не ПустаяСтрока(КодФильтр) Тогда
			УсловиеГде = УсловиеГде + " И Номенклатура.Код ПОДОБНО &КодФильтр";
		КонецЕсли;
		Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
			УсловиеГде = УсловиеГде + " И Номенклатура.Наименование ПОДОБНО &НаименованиеФильтр";
		КонецЕсли;

		ЗапросБД = Новый Запрос;
		ЗапросБД.Текст =
			"ВЫБРАТЬ
			|   Номенклатура.Код КАК Код,
			|   Номенклатура.Наименование КАК Наименование,
			|   Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
			|   Номенклатура.ВидНоменклатуры.Наименование КАК ВидНоменклатуры,
			|   Номенклатура.НоменклатурнаяГруппа.Наименование КАК НоменклатурнаяГруппа,
			|   Номенклатура.Родитель КАК Родитель
			|ИЗ
			|   Справочник.Номенклатура КАК Номенклатура
			|ГДЕ
			|   " + УсловиеГде + "
			|УПОРЯДОЧИТЬ ПО
			|   Номенклатура.Наименование";

		Если Не ПустаяСтрока(КодФильтр) Тогда
			ЗапросБД.УстановитьПараметр("КодФильтр", "%" + КодФильтр + "%");
		КонецЕсли;
		Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
			ЗапросБД.УстановитьПараметр("НаименованиеФильтр", "%" + НаименованиеФильтр + "%");
		КонецЕсли;

		Результат = ЗапросБД.Выполнить();
		Выборка = Результат.Выбрать();

		// 2. Остатки по всем складам (без фильтра по складу)
		ЗапросОстатков = Новый Запрос;
		ЗапросОстатков.Текст =
			"ВЫБРАТЬ
			|   Остатки.Номенклатура.Код КАК Код,
			|   Остатки.Склад.Наименование КАК Склад,
			|   Остатки.КоличествоОстаток КАК Количество
			|ИЗ
			|   РегистрНакопления.ТоварыНаСкладах.Остатки(&ДатаСреза) КАК Остатки";
		ЗапросОстатков.УстановитьПараметр("ДатаСреза", ТекущаяДатаСеанса());
		РезультатОстатков = ЗапросОстатков.Выполнить();
		ВыборкаОстатков = РезультатОстатков.Выбрать();

		// Код -> массив {Склад, Количество}
		ОстаткиПоКоду = Новый Соответствие;
		Пока ВыборкаОстатков.Следующий() Цикл
			КодНом = СокрЛП(Строка(ВыборкаОстатков.Код));
			МассивОстатков = ОстаткиПоКоду.Получить(КодНом);
			Если МассивОстатков = Неопределено Тогда
				МассивОстатков = Новый Массив;
				ОстаткиПоКоду.Вставить(КодНом, МассивОстатков);
			КонецЕсли;
			СтрокаОстатка = Новый Структура("Склад, Количество", Строка(ВыборкаОстатков.Склад), Число(ВыборкаОстатков.Количество));
			МассивОстатков.Добавить(СтрокаОстатка);
		КонецЦикла;

		// 3. Построение дерева (как в materials.bsl)
		ГруппыПоКоду = Новый Соответствие;
		КорневыеУзлы = Новый Массив;

		Пока Выборка.Следующий() Цикл
			ЦепочкаРодителей = Новый Массив;
			ТекущийРодитель = Выборка.Родитель;
			Пока ЗначениеЗаполнено(ТекущийРодитель) Цикл
				ЦепочкаРодителей.Вставить(0, ТекущийРодитель);
				ТекущийРодитель = ТекущийРодитель.Родитель;
			КонецЦикла;

			ТекущийМассивДетей = КорневыеУзлы;
			Для Каждого ЭлементЦепочки Из ЦепочкаРодителей Цикл
				КодГруппы = СокрЛП(Строка(ЭлементЦепочки.Код));
				УзелГруппы = ГруппыПоКоду.Получить(КодГруппы);
				Если УзелГруппы = Неопределено Тогда
					УзелГруппы = Новый Структура;
					УзелГруппы.Вставить("Код",          КодГруппы);
					УзелГруппы.Вставить("Наименование",  СокрЛП(Строка(ЭлементЦепочки.Наименование)));
					УзелГруппы.Вставить("ЭтоГруппа",     Истина);
					УзелГруппы.Вставить("Дети",          Новый Массив);
					ГруппыПоКоду.Вставить(КодГруппы, УзелГруппы);
					ТекущийМассивДетей.Добавить(УзелГруппы);
				КонецЕсли;
				ТекущийМассивДетей = УзелГруппы.Дети;
			КонецЦикла;

			// Материал (лист дерева) с остатками по складам
			КодМатериала = СокрЛП(Строка(Выборка.Код));
			Материал = Новый Структура;
			Материал.Вставить("Код",                  КодМатериала);
			Материал.Вставить("Наименование",          СокрЛП(Строка(Выборка.Наименование)));
			Материал.Вставить("ЭтоГруппа",             Ложь);
			Материал.Вставить("ЕдиницаИзмерения",      СокрЛП(Строка(Выборка.ЕдиницаИзмерения)));
			Материал.Вставить("ВидНоменклатуры",        СокрЛП(Строка(Выборка.ВидНоменклатуры)));
			Материал.Вставить("НоменклатурнаяГруппа",   СокрЛП(Строка(Выборка.НоменклатурнаяГруппа)));
			МассивОстатковМатериала = ОстаткиПоКоду.Получить(КодМатериала);
			Если МассивОстатковМатериала = Неопределено Тогда
				МассивОстатковМатериала = Новый Массив;
			КонецЕсли;
			Материал.Вставить("Остатки", МассивОстатковМатериала);

			ТекущийМассивДетей.Добавить(Материал);
		КонецЦикла;

		JSON = Новый ЗаписьJSON;
		JSON.УстановитьСтроку();
		ЗаписатьJSON(JSON, КорневыеУзлы);
		JSONСтрока = JSON.Закрыть();

		Ответ = Новый HTTPСервисОтвет(200);
		Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
		Ответ.УстановитьТелоИзСтроки(JSONСтрока);
		Возврат Ответ;
	Исключение
		ОписаниеОшибки = ОписаниеОшибки();
		Ответ = Новый HTTPСервисОтвет(500);
		Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
		Ответ.УстановитьТелоИзСтроки(ОписаниеОшибки);
		Возврат Ответ;
	КонецПопытки;
КонецФункции
