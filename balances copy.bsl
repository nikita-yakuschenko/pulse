Функция GetBalances(Запрос)
	Попытка
        МассивОстатков = Новый Массив;
        
        // Получаем параметры из HTTP запроса
        // Параметры должны быть указаны в шаблоне URL: /get/{code} или /get/{code}/{name}
        // Тогда они будут доступны через Запрос.ПараметрыURL["code"]
        КодФильтр = "";
        НаименованиеФильтр = "";
        
        // Прямой доступ к параметрам, как в примере
        Попытка
            КодФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["code"]));
        Исключение
            // Параметр не найден - это нормально, если он не передан
            КодФильтр = "";
        КонецПопытки;
        
        Попытка
            НаименованиеФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["name"]));
        Исключение
            // Параметр не найден - это нормально, если он не передан
            НаименованиеФильтр = "";
        КонецПопытки;
		
        ЗапросБД = Новый Запрос;
        
        // Формируем условие WHERE динамически в зависимости от наличия параметров
        УсловиеГде = "Остатки.Склад.Код = &КодСклада";
        
        Если Не ПустаяСтрока(КодФильтр) Тогда
            // Поиск по коду с игнорированием ведущих нулей
            // Пользователь может ввести "7386" вместо "00000007386"
            // Используем ПОДОБНО для поиска кода, заканчивающегося на введенное значение
            УсловиеГде = УсловиеГде + " И Остатки.Номенклатура.Код ПОДОБНО &КодФильтр";
        КонецЕсли;
        
        Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
            // Частичное совпадение по наименованию
            УсловиеГде = УсловиеГде + " И Остатки.Номенклатура.Наименование ПОДОБНО &НаименованиеФильтр";
        КонецЕсли;
        
        ЗапросБД.Текст = 
            "ВЫБРАТЬ
            |	Остатки.Номенклатура.Код КАК Код,
            |	Остатки.Номенклатура.Наименование КАК Наименование,
            |	Остатки.Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
            |	Остатки.КоличествоОстаток КАК Количество
            |ИЗ
            |	РегистрНакопления.ТоварыНаСкладах.Остатки(&ДатаСреза) КАК Остатки
            |ГДЕ
            |	" + УсловиеГде;
            
		ЗапросБД.УстановитьПараметр("ДатаСреза", ТекущаяДатаСеанса());	
		ЗапросБД.УстановитьПараметр("КодСклада", "000000007");
		
		// Устанавливаем параметры фильтрации только если они заданы
		Если Не ПустаяСтрока(КодФильтр) Тогда
		    // Добавляем % в начало для поиска кода, заканчивающегося на введенное значение
		    // Это позволяет находить "00000007386" по запросу "7386"
		    ЗапросБД.УстановитьПараметр("КодФильтр", "%" + КодФильтр + "%");
		КонецЕсли;
		
		Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
		    ЗапросБД.УстановитьПараметр("НаименованиеФильтр", "%" + НаименованиеФильтр + "%");
		КонецЕсли;
		
        Результат = ЗапросБД.Выполнить();
        Выборка = Результат.Выбрать();

        Пока Выборка.Следующий() Цикл
            Материал = Новый Структура;
            
            Материал.Вставить("Код", Строка(Выборка.Код));
            Материал.Вставить("Наименование", Строка(Выборка.Наименование));
            Материал.Вставить("ЕдиницаИзмерения", Строка(Выборка.ЕдиницаИзмерения));
            Материал.Вставить("Количество", Число(Выборка.Количество));
            
            МассивОстатков.Добавить(Материал);
        КонецЦикла;

        JSON = Новый ЗаписьJSON;
        JSON.УстановитьСтроку();
        ЗаписатьJSON(JSON, МассивОстатков);
        JSONСтрока = JSON.Закрыть();

        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(JSONСтрока);
        Возврат Ответ;
    Исключение
        ОписаниеОшибки = ОписаниеОшибки();
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(ОписаниеОшибки);
        Возврат Ответ;
    КонецПопытки;
КонецФункции
