Функция GetPayments(Запрос)
    Попытка
        МассивЗаявкиРасход = Новый Массив;
        
        // Параметры: /get/full/{full}, /get/code/{code}, /get/contractor/{contractor}, /get/org/{org}, /get/status/{status}, /get/responsible/{responsible}
        ПолныйРежим = Ложь;
        ПолныйПараметр = "";
        КодФильтр = "";
        КонтрагентФильтр = "";
        ОрганизацияФильтр = "";
        СтатусФильтр = "";
        ОтветственныйФильтр = "";
        
        Попытка
            ПолныйПараметр = НРег(СокрЛП(Строка(Запрос.ПараметрыURL["full"])));
        Исключение
            ПолныйПараметр = "";
        КонецПопытки;
        Если Не ПустаяСтрока(ПолныйПараметр) Тогда
            Если ПолныйПараметр = "1"
                Или ПолныйПараметр = "true"
                Или ПолныйПараметр = "yes"
                Или ПолныйПараметр = "full" Тогда
                ПолныйРежим = Истина;
            КонецЕсли;
        КонецЕсли;
        
        Попытка
            КодФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["code"]));
        Исключение
            КодФильтр = "";
        КонецПопытки;
        Попытка
            КонтрагентФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["contractor"]));
        Исключение
            КонтрагентФильтр = "";
        КонецПопытки;
        // Обработка спец. маркера для "+" в path
        Если Не ПустаяСтрока(КонтрагентФильтр) Тогда
            // В GET path IIS режет "+", поэтому используем замену "_plus_" -> "+"
            КонтрагентФильтр = СтрЗаменить(КонтрагентФильтр, "_plus_", "+");
            // Поддержка дефиса/минуса: "_dash_" или "_minus_" -> "-"
            КонтрагентФильтр = СтрЗаменить(КонтрагентФильтр, "_dash_", "-");
            КонтрагентФильтр = СтрЗаменить(КонтрагентФильтр, "_minus_", "-");
        КонецЕсли;
        Попытка
            ОрганизацияФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["org"]));
        Исключение
            ОрганизацияФильтр = "";
        КонецПопытки;
        Попытка
            СтатусФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["status"]));
        Исключение
            СтатусФильтр = "";
        КонецПопытки;
        Попытка
            ОтветственныйФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["responsible"]));
        Исключение
            ОтветственныйФильтр = "";
        КонецПопытки;
        
        Если ПолныйРежим И ПустаяСтрока(КодФильтр) И ПустаяСтрока(КонтрагентФильтр) Тогда
            Ответ = Новый HTTPСервисОтвет(400);
            Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
            Ответ.УстановитьТелоИзСтроки("full требует фильтр: code или contractor");
            Возврат Ответ;
        КонецЕсли;
        
        УсловиеГде = "";
        Если Не ПустаяСтрока(КодФильтр) Тогда
            УсловиеГде = "Заявка.Номер ПОДОБНО &КодФильтр";
        КонецЕсли;
        Если Не ПустаяСтрока(КонтрагентФильтр) Тогда
            УсловиеГде = УсловиеГде + ?(ПустаяСтрока(УсловиеГде), "", " И ")
                + "Заявка.Контрагент.Наименование ПОДОБНО &КонтрагентФильтр";
        КонецЕсли;
        Если Не ПустаяСтрока(ОрганизацияФильтр) Тогда
            УсловиеГде = УсловиеГде + ?(ПустаяСтрока(УсловиеГде), "", " И ")
                + "Заявка.Организация.Наименование ПОДОБНО &ОрганизацияФильтр";
        КонецЕсли;
        Если Не ПустаяСтрока(ОтветственныйФильтр) Тогда
            УсловиеГде = УсловиеГде + ?(ПустаяСтрока(УсловиеГде), "", " И ")
                + "Заявка.Ответственный.Наименование ПОДОБНО &ОтветственныйФильтр";
        КонецЕсли;
        
        Если ПолныйРежим Тогда
            // Полный режим (открытие карточки заявки): запрос с хранилищем, ТЧ, ДопИнформация, ФайлBase64
            ЗапросБД = Новый Запрос;
            ЗапросБД.Текст = 
                "ВЫБРАТЬ
                |	Заявка.Ссылка КАК Ссылка,
                |	Заявка.Номер КАК Номер,
                |	Заявка.Дата КАК Дата,
                |	Заявка.Контрагент.Наименование КАК Контрагент,
                |	Заявка.Организация.Наименование КАК Организация,
                |	Заявка.СуммаДокумента КАК Сумма,
                |	Заявка.Ответственный.Наименование КАК Ответственный,
                |	ПРЕДСТАВЛЕНИЕ(Заявка.ВидОперации.Ссылка) КАК ВидОперации,
                |	ПРЕДСТАВЛЕНИЕ(Заявка.БанковскийСчетКасса.Ссылка) КАК Счёт,
                |	ПРЕДСТАВЛЕНИЕ(Заявка.Состояние) КАК Статус,
                |	ХранилищеДополнительнойИнформации.Ссылка КАК СсылкаХранилища,
                |	ХранилищеДополнительнойИнформации.ТекстФайла КАК ТекстФайла,
                |	ХранилищеДополнительнойИнформации.Представление КАК ПредставлениеХранилища,
                |	ХранилищеДополнительнойИнформации.ВидДанных.Порядок КАК ПорядокВидДанных,
                |	ХранилищеДополнительнойИнформации.ВидДанных.Ссылка КАК СсылкаВидДанных,
                |	ХранилищеДополнительнойИнформации.Хранилище КАК ХранилищеДанные,
                |	ХранилищеДополнительнойИнформации.ИмяФайла КАК ИмяФайла,
                |	ХранилищеДополнительнойИнформации.Объект КАК ОбъектХранилища
                |ИЗ
                |	Документ.ЗаявкаНаРасходованиеСредств КАК Заявка
                |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХранилищеДополнительнойИнформации КАК ХранилищеДополнительнойИнформации
                |		ПО Заявка.Ссылка = ХранилищеДополнительнойИнформации.Объект"
                + ?(ПустаяСтрока(УсловиеГде), "", "
                |ГДЕ
                |   " + УсловиеГде);
            
            Если Не ПустаяСтрока(КодФильтр) Тогда
                ЗапросБД.УстановитьПараметр("КодФильтр", "%" + КодФильтр + "%");
            КонецЕсли;
            Если Не ПустаяСтрока(КонтрагентФильтр) Тогда
                ЗапросБД.УстановитьПараметр("КонтрагентФильтр", "%" + КонтрагентФильтр + "%");
            КонецЕсли;
            Если Не ПустаяСтрока(ОрганизацияФильтр) Тогда
                ЗапросБД.УстановитьПараметр("ОрганизацияФильтр", "%" + ОрганизацияФильтр + "%");
            КонецЕсли;
            Если Не ПустаяСтрока(ОтветственныйФильтр) Тогда
                ЗапросБД.УстановитьПараметр("ОтветственныйФильтр", "%" + ОтветственныйФильтр + "%");
            КонецЕсли;

            Результат = ЗапросБД.Выполнить();
            Выборка = Результат.Выбрать();

            ПредыдущаяСсылкаЗаявки = Неопределено;
            ЗаявкаРасход = Неопределено;

            Пока Выборка.Следующий() Цикл
                // Смена заявки: сохраняем предыдущую в массив и начинаем новую
                Если ПредыдущаяСсылкаЗаявки <> Неопределено И Выборка.Ссылка <> ПредыдущаяСсылкаЗаявки Тогда
                    МассивЗаявкиРасход.Добавить(ЗаявкаРасход);
                КонецЕсли;
                ЗаявкаТолькоЧтоСоздана = Ложь;
                Если ЗаявкаРасход = Неопределено Или Выборка.Ссылка <> ПредыдущаяСсылкаЗаявки Тогда
                    ПредыдущаяСсылкаЗаявки = Выборка.Ссылка;
                    ЗаявкаРасход = Новый Структура;
                    ДопИнформация = Новый Массив;
                    ЗаявкаТолькоЧтоСоздана = Истина;

                    ЗаявкаРасход.Вставить("Ссылка", ?(Выборка.Ссылка = Неопределено, "", Строка(Выборка.Ссылка)));
                    Если Выборка.Дата = Неопределено Тогда
                        ЗаявкаРасход.Вставить("Дата", "");
                    Иначе
                        ЗаявкаРасход.Вставить("Дата", Строка(Выборка.Дата));
                    КонецЕсли;

                    Если Выборка.Номер = Неопределено Тогда
                        ЗаявкаРасход.Вставить("Номер", "");
                    Иначе
                        ЗаявкаРасход.Вставить("Номер", Строка(Выборка.Номер));
                    КонецЕсли;

                    Если Выборка.Контрагент = Неопределено Тогда
                        ЗаявкаРасход.Вставить("Контрагент", "Не указан");
                    Иначе
                        ЗаявкаРасход.Вставить("Контрагент", Строка(Выборка.Контрагент));
                    КонецЕсли;

                    Если Выборка.Организация = Неопределено Тогда
                        ЗаявкаРасход.Вставить("Организация", "Не указана");
                    Иначе
                        ЗаявкаРасход.Вставить("Организация", Строка(Выборка.Организация));
                    КонецЕсли;

                    Если Выборка.Ответственный = Неопределено Тогда
                        ЗаявкаРасход.Вставить("Ответственный", "Не указан");
                    Иначе
                        ЗаявкаРасход.Вставить("Ответственный", Строка(Выборка.Ответственный));
                    КонецЕсли;

                    Если Выборка.Сумма = Неопределено Тогда
                        ЗаявкаРасход.Вставить("Сумма", 0);
                    Иначе
                        ЗаявкаРасход.Вставить("Сумма", Число(Выборка.Сумма));
                    КонецЕсли;

                    Если Выборка.ВидОперации = Неопределено Тогда
                        ЗаявкаРасход.Вставить("ВидОперации", "Не указан");
                    Иначе
                        ЗаявкаРасход.Вставить("ВидОперации", Строка(Выборка.ВидОперации));
                    КонецЕсли;

                    Если Выборка.Счёт = Неопределено Тогда
                        ЗаявкаРасход.Вставить("Счёт", "Не указан");
                    Иначе
                        ЗаявкаРасход.Вставить("Счёт", Строка(Выборка.Счёт));
                    КонецЕсли;

                    Если Выборка.Статус = Неопределено Тогда
                        ЗаявкаРасход.Вставить("Статус", "Не указан");
                    Иначе
                        ЗаявкаРасход.Вставить("Статус", Строка(Выборка.Статус));
                    КонецЕсли;
                    
                    // Добавляем пустой массив для файлов сразу при создании заявки
                    ЗаявкаРасход.Вставить("ДопИнформация", ДопИнформация);
                КонецЕсли;

                // Данные из хранилища дополнительной информации (если есть) — все поля из запроса
                Если ЗначениеЗаполнено(Выборка.СсылкаХранилища) Тогда
                    ЭлементДоп = Новый Структура;
                    ЭлементДоп.Вставить("СсылкаХранилища", Строка(Выборка.СсылкаХранилища));
                    ЭлементДоп.Вставить("Объект", ?(Выборка.ОбъектХранилища = Неопределено, "", Строка(Выборка.ОбъектХранилища)));
                    ЭлементДоп.Вставить("Представление", ?(Выборка.ПредставлениеХранилища = Неопределено, "", Строка(Выборка.ПредставлениеХранилища)));
                    ЭлементДоп.Вставить("ИмяФайла", ?(Выборка.ИмяФайла = Неопределено, "", Строка(Выборка.ИмяФайла)));
                    ЭлементДоп.Вставить("ТекстФайла", ?(Выборка.ТекстФайла = Неопределено, "", Строка(Выборка.ТекстФайла)));
                    ЭлементДоп.Вставить("ПорядокВидДанных", ?(Выборка.ПорядокВидДанных = Неопределено, 0, Выборка.ПорядокВидДанных));
                    ЭлементДоп.Вставить("СсылкаВидДанных", ?(ЗначениеЗаполнено(Выборка.СсылкаВидДанных), Строка(Выборка.СсылкаВидДанных), ""));
                    ЭлементДоп.Вставить("ЕстьВложение", ЗначениеЗаполнено(Выборка.СсылкаХранилища));
                    ЭлементДоп.Вставить("ИдентификаторХранилища", Строка(Выборка.СсылкаХранилища.УникальныйИдентификатор()));
                    // При full — содержимое файла в Base64. Сначала из выборки; если пусто (файловое хранилище) — по ссылке на запись.
                    Если ПолныйРежим И ЗначениеЗаполнено(Выборка.СсылкаХранилища) Тогда
                        ДвоичныеДанные = Неопределено;
                        Если ЗначениеЗаполнено(Выборка.ХранилищеДанные) Тогда
                            Попытка
                                ДвоичныеДанные = Выборка.ХранилищеДанные.Получить();
                            Исключение
                            КонецПопытки;
                        КонецЕсли;
                        Если ДвоичныеДанные = Неопределено Тогда
                            ДвоичныеДанные = ПолучитьДвоичныеДанныеИзХранилищаПоСсылке(Выборка.СсылкаХранилища);
                        КонецЕсли;
                        ЭлементДоп.Вставить("ФайлBase64", ДвоичныеДанныеВBase64(ДвоичныеДанные));
                    КонецЕсли;
                    ДопИнформация.Добавить(ЭлементДоп);
                КонецЕсли;

                // Полный режим (ТЧ, комментарий) — один раз на заявку
                Если ПолныйРежим И ЗаявкаТолькоЧтоСоздана Тогда
                    ОбъектЗаявка = Выборка.Ссылка.ПолучитьОбъект();
                    
                    // Табличная часть РасшифровкаПлатежа (если есть)
                    РасшифровкаПлатежа = Новый Массив;
                    Попытка
                        Для Каждого СтрокаТЧ Из ОбъектЗаявка.РасшифровкаПлатежа Цикл
                            Стр = Новый Структура;
                            Стр.Вставить("НомерСтроки", Строка(СтрокаТЧ.НомерСтроки));
                            Стр.Вставить("Содержание", ?(ЗначениеЗаполнено(СтрокаТЧ.Содержание), Строка(СтрокаТЧ.Содержание), ""));
                            Стр.Вставить("Сумма", СтрокаТЧ.Сумма);
                            Стр.Вставить("СтавкаНДС", Строка(СтрокаТЧ.СтавкаНДС));
                            Стр.Вставить("СуммаНДС", СтрокаТЧ.СуммаНДС);
                            РасшифровкаПлатежа.Добавить(Стр);
                        КонецЦикла;
                    Исключение
                        // Если ТЧ не существует, просто пропускаем
                    КонецПопытки;
                    
                    ЗаявкаРасход.Вставить("РасшифровкаПлатежа", РасшифровкаПлатежа);
                    
                    // Комментарий из шапки документа
                    Если ОбъектЗаявка.Комментарий = Неопределено Тогда
                        ЗаявкаРасход.Вставить("Комментарий", "");
                    Иначе
                        ЗаявкаРасход.Вставить("Комментарий", Строка(ОбъектЗаявка.Комментарий));
                    КонецЕсли;
                КонецЕсли;
            КонецЦикла;

            // Последняя заявка в выборке
            Если ЗаявкаРасход <> Неопределено Тогда
                МассивЗаявкиРасход.Добавить(ЗаявкаРасход);
            КонецЕсли;
        Иначе
            // Режим списка (/get/list или с фильтрами без full): только основные поля, без хранилища и ТЧ — быстрый ответ
            ЗапросБД = Новый Запрос;
            ЗапросБД.Текст = 
                "ВЫБРАТЬ
                |	Заявка.Дата КАК Дата,
                |	Заявка.Номер КАК Номер,
                |	Заявка.Контрагент.Наименование КАК Контрагент,
                |	Заявка.Организация.Наименование КАК Организация,
                |	Заявка.Ответственный.Наименование КАК Ответственный,
                |	Заявка.СуммаДокумента КАК Сумма,
                |	ПРЕДСТАВЛЕНИЕ(Заявка.ВидОперации.Ссылка) КАК ВидОперации,
                |	ПРЕДСТАВЛЕНИЕ(Заявка.БанковскийСчетКасса.Ссылка) КАК Счёт,
                |	ПРЕДСТАВЛЕНИЕ(Заявка.Состояние) КАК Статус
                |ИЗ
                |	Документ.ЗаявкаНаРасходованиеСредств КАК Заявка"
                + ?(ПустаяСтрока(УсловиеГде), "", "
                |ГДЕ
                |   " + УсловиеГде);
            
            Если Не ПустаяСтрока(КодФильтр) Тогда
                ЗапросБД.УстановитьПараметр("КодФильтр", "%" + КодФильтр + "%");
            КонецЕсли;
            Если Не ПустаяСтрока(КонтрагентФильтр) Тогда
                ЗапросБД.УстановитьПараметр("КонтрагентФильтр", "%" + КонтрагентФильтр + "%");
            КонецЕсли;
            Если Не ПустаяСтрока(ОрганизацияФильтр) Тогда
                ЗапросБД.УстановитьПараметр("ОрганизацияФильтр", "%" + ОрганизацияФильтр + "%");
            КонецЕсли;
            Если Не ПустаяСтрока(ОтветственныйФильтр) Тогда
                ЗапросБД.УстановитьПараметр("ОтветственныйФильтр", "%" + ОтветственныйФильтр + "%");
            КонецЕсли;

            Результат = ЗапросБД.Выполнить();
            Выборка = Результат.Выбрать();

            Пока Выборка.Следующий() Цикл
                // Статус (и фильтрация по нему на клиенте)
                Если Не ЗначениеЗаполнено(Выборка.Статус) Тогда
                    СтатусЗначение = "Не указан";
                Иначе
                    СтатусЗначение = Строка(Выборка.Статус);
                КонецЕсли;
                
                Если Не ПустаяСтрока(СтатусФильтр) Тогда
                    Если СтрНайти(ВРег(СтатусЗначение), ВРег(СтатусФильтр)) = 0 Тогда
                        Продолжить;
                    КонецЕсли;
                КонецЕсли;
                
                ЗаявкаРасход = Новый Структура;
                ЗаявкаРасход.Вставить("Дата", ?(Выборка.Дата = Неопределено, "", Строка(Выборка.Дата)));
                ЗаявкаРасход.Вставить("Номер", ?(Выборка.Номер = Неопределено, "", Строка(Выборка.Номер)));
                ЗаявкаРасход.Вставить("Контрагент", ?(Выборка.Контрагент = Неопределено, "Не указан", Строка(Выборка.Контрагент)));
                ЗаявкаРасход.Вставить("Организация", ?(Выборка.Организация = Неопределено, "Не указана", Строка(Выборка.Организация)));
                ЗаявкаРасход.Вставить("Ответственный", ?(Выборка.Ответственный = Неопределено, "Не указан", Строка(Выборка.Ответственный)));
                ЗаявкаРасход.Вставить("Сумма", ?(Выборка.Сумма = Неопределено, 0, Число(Выборка.Сумма)));
                ЗаявкаРасход.Вставить("ВидОперации", ?(Выборка.ВидОперации = Неопределено, "Не указан", Строка(Выборка.ВидОперации)));
                ЗаявкаРасход.Вставить("Счёт", ?(Выборка.Счёт = Неопределено, "Не указан", Строка(Выборка.Счёт)));
                ЗаявкаРасход.Вставить("Статус", СтатусЗначение);
                МассивЗаявкиРасход.Добавить(ЗаявкаРасход);
            КонецЦикла;
        КонецЕсли;

        JSON = Новый ЗаписьJSON;
        JSON.УстановитьСтроку();
        ЗаписатьJSON(JSON, МассивЗаявкиРасход);
        JSONСтрока = JSON.Закрыть();

        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(JSONСтрока);
        Возврат Ответ;
    Исключение
        ОписаниеОшибки = ОписаниеОшибки();
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(ОписаниеОшибки);
        Возврат Ответ;
    КонецПопытки;
КонецФункции

// Возвращает двоичные данные из записи ХранилищеДополнительнойИнформации по ссылке.
// Через запрос (как в GetSOrderFile) — надёжно при любом типе хранилища.
Функция ПолучитьДвоичныеДанныеИзХранилищаПоСсылке(СсылкаХранилища)
    ДвоичныеДанные = Неопределено;
    Попытка
        ЗапросБД = Новый Запрос;
        ЗапросБД.Текст =
            "ВЫБРАТЬ
            |	ХранилищеДополнительнойИнформации.Хранилище КАК Хранилище
            |ИЗ
            |	Справочник.ХранилищеДополнительнойИнформации КАК ХранилищеДополнительнойИнформации
            |ГДЕ
            |	ХранилищеДополнительнойИнформации.Ссылка = &Ссылка";
        ЗапросБД.УстановитьПараметр("Ссылка", СсылкаХранилища);
        Результат = ЗапросБД.Выполнить();
        Выборка = Результат.Выбрать();
        Если Не Выборка.Следующий() Тогда
            Возврат Неопределено;
        КонецЕсли;
        ХранилищеЗначения = Выборка.Хранилище;
        Если Не ЗначениеЗаполнено(ХранилищеЗначения) Тогда
            Возврат Неопределено;
        КонецЕсли;
        ЗначениеИзХранилища = ХранилищеЗначения.Получить();
        // По подсказке с forum.mista.ru/topic/501041: Получить() может вернуть не ДвоичныеДанные
        Если ТипЗнч(ЗначениеИзХранилища) = Тип("ДвоичныеДанные") Тогда
            ДвоичныеДанные = ЗначениеИзХранилища;
        Иначе
            // Обходной путь: тип с методом Записать(Путь) — пишем во временный файл и читаем как ДвоичныеДанные
            Попытка
                ВременныйФайл = ПолучитьИмяВременногоФайла();
                ЗначениеИзХранилища.Записать(ВременныйФайл);
                ДвоичныеДанные = Новый ДвоичныеДанные(ВременныйФайл);
                УдалитьФайлы(ВременныйФайл);
            Исключение
                ДвоичныеДанные = Неопределено;
            КонецПопытки;
        КонецЕсли;
    Исключение
        Возврат Неопределено;
    КонецПопытки;
    Возврат ДвоичныеДанные;
КонецФункции

// Кодирует двоичные данные в строку Base64 (для выдачи файла в JSON при full).
// Варианты: Base64Строка платформы → ОбщегоНазначения → автономное кодирование через поток.
Функция ДвоичныеДанныеВBase64(ДвоичныеДанные)
    Если ДвоичныеДанные = Неопределено Тогда
        Возврат "";
    КонецЕсли;
    Попытка
        Возврат Base64Строка(ДвоичныеДанные);
    Исключение
        Попытка
            Возврат ОбщегоНазначения.ДвоичныеДанныеВСтрокуBase64(ДвоичныеДанные);
        Исключение
            Попытка
                Возврат ДвоичныеДанныеВBase64ПоБайтам(ДвоичныеДанные);
            Исключение
                Возврат "";
            КонецПопытки;
        КонецПопытки;
    КонецПопытки;
КонецФункции

// Автономное кодирование Base64 по байтам (без внешних функций).
Функция ДвоичныеДанныеВBase64ПоБайтам(ДвоичныеДанные)
    Попытка
        Поток = ДвоичныеДанные.ОткрытьПотокДляЧтения();
    Исключение
        Возврат "";
    КонецПопытки;
    Попытка
        Размер = ДвоичныеДанные.Размер;
    Исключение
        Возврат "";
    КонецПопытки;
    Если Размер = 0 Тогда
        Возврат "";
    КонецЕсли;
    Алфавит = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
    Результат = "";
    ЧтениеД = Новый ЧтениеДанных(Поток);
    Смещение = 0;
    Пока Смещение < Размер Цикл
        Байт0 = 0;
        Байт1 = 0;
        Байт2 = 0;
        Попытка
            Байт0 = ЧтениеД.ПрочитатьЦелое8(Истина);
            Смещение = Смещение + 1;
        Исключение
        КонецПопытки;
        Если Смещение < Размер Тогда
            Попытка
                Байт1 = ЧтениеД.ПрочитатьЦелое8(Истина);
                Смещение = Смещение + 1;
            Исключение
            КонецПопытки;
        КонецЕсли;
        Если Смещение < Размер Тогда
            Попытка
                Байт2 = ЧтениеД.ПрочитатьЦелое8(Истина);
                Смещение = Смещение + 1;
            Исключение
            КонецПопытки;
        КонецЕсли;
        Н = Байт0 * 65536 + Байт1 * 256 + Байт2;
        Результат = Результат + Сред(Алфавит, Цел(Н / 262144) + 1, 1) + Сред(Алфавит, Цел(Н / 4096) % 64 + 1, 1)
            + Сред(Алфавит, Цел(Н / 64) % 64 + 1, 1) + Сред(Алфавит, Н % 64 + 1, 1);
    КонецЦикла;
    Попытка
        ЧтениеД.Закрыть();
    Исключение
    КонецПопытки;
    Остаток = Размер % 3;
    Если Остаток = 1 Тогда
        Результат = Лев(Результат, СтрДлина(Результат) - 2) + "==";
    ИначеЕсли Остаток = 2 Тогда
        Результат = Лев(Результат, СтрДлина(Результат) - 1) + "=";
    КонецЕсли;
    Возврат Результат;
КонецФункции

// Возвращает файл из хранилища дополнительной информации по идентификатору записи.
// URL: например /get/file/{id}, где id = ИдентификаторХранилища из элемента ДопИнформация.
Функция GetPaymentFile(Запрос)
    Попытка
        ИдентификаторСтрока = "";
        Попытка
            ИдентификаторСтрока = СокрЛП(Строка(Запрос.ПараметрыURL["id"]));
        Исключение
        КонецПопытки;
        Если ПустаяСтрока(ИдентификаторСтрока) Тогда
            Ответ = Новый HTTPСервисОтвет(400);
            Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
            Ответ.УстановитьТелоИзСтроки("Параметр id обязателен");
            Возврат Ответ;
        КонецЕсли;

        Ссылка = Справочники.ХранилищеДополнительнойИнформации.ПолучитьСсылку(Новый УникальныйИдентификатор(ИдентификаторСтрока));
        ЗапросБД = Новый Запрос;
        ЗапросБД.Текст =
            "ВЫБРАТЬ
            |	ХранилищеДополнительнойИнформации.Хранилище КАК Хранилище,
            |	ХранилищеДополнительнойИнформации.ИмяФайла КАК ИмяФайла,
            |	ХранилищеДополнительнойИнформации.Ссылка,
            |	ХранилищеДополнительнойИнформации.ВидДанных.Ссылка,
            |	ХранилищеДополнительнойИнформации.ВидДанных.Порядок,
            |	ХранилищеДополнительнойИнформации.Хранилище КАК Хранилище1
            |ИЗ
            |	Справочник.ХранилищеДополнительнойИнформации КАК ХранилищеДополнительнойИнформации
            |ГДЕ
            |	ХранилищеДополнительнойИнформации.Ссылка = &Ссылка";
        ЗапросБД.УстановитьПараметр("Ссылка", Ссылка);
        Результат = ЗапросБД.Выполнить();
        Выборка = Результат.Выбрать();
        Если Не Выборка.Следующий() Тогда
            Ответ = Новый HTTPСервисОтвет(404);
            Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
            Ответ.УстановитьТелоИзСтроки("Файл не найден");
            Возврат Ответ;
        КонецЕсли;

        ХранилищеЗначения = Выборка.Хранилище;
        Если Не ЗначениеЗаполнено(ХранилищеЗначения) Тогда
            Ответ = Новый HTTPСервисОтвет(404);
            Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
            Ответ.УстановитьТелоИзСтроки("Вложение пусто");
            Возврат Ответ;
        КонецЕсли;

        ДвоичныеДанные = ХранилищеЗначения.Получить();
        ИмяФайла = ?(Выборка.ИмяФайла = Неопределено Или ПустаяСтрока(Выборка.ИмяФайла), "file", Строка(Выборка.ИмяФайла));
        // Убираем недопустимые символы из имени файла в заголовке
        ИмяФайла = СтрЗаменить(ИмяФайла, Символ(0), "");
        Если СтрДлина(ИмяФайла) > 200 Тогда
            ИмяФайла = Лев(ИмяФайла, 200);
        КонецЕсли;

        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.Заголовки.Вставить("Content-Type", "application/octet-stream");
        Ответ.Заголовки.Вставить("Content-Disposition", "attachment; filename=""" + ИмяФайла + """");
        Ответ.УстановитьТелоИзДвоичныхДанных(ДвоичныеДанные);
        Возврат Ответ;
    Исключение
        ОписаниеОшибки = ОписаниеОшибки();
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(ОписаниеОшибки);
        Возврат Ответ;
    КонецПопытки;
КонецФункции
