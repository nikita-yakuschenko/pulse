Функция GetMaterials(Запрос)
    Попытка
        // Параметры из URL: /get/code/{code} и /get/name/{name}
        КодФильтр = "";
        НаименованиеФильтр = "";
        Попытка
            КодФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["code"]));
        Исключение
            КодФильтр = "";
        КонецПопытки;
        Попытка
            НаименованиеФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["name"]));
        Исключение
            НаименованиеФильтр = "";
        КонецПопытки;

        // Условие WHERE — только элементы (не группы), исключаем помеченные на удаление
        УсловиеГде = "Номенклатура.ПометкаУдаления = ЛОЖЬ И Номенклатура.ЭтоГруппа = ЛОЖЬ";
        Если Не ПустаяСтрока(КодФильтр) Тогда
            УсловиеГде = УсловиеГде + " И Номенклатура.Код ПОДОБНО &КодФильтр";
        КонецЕсли;
        Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
            УсловиеГде = УсловиеГде + " И Номенклатура.Наименование ПОДОБНО &НаименованиеФильтр";
        КонецЕсли;

        ЗапросБД = Новый Запрос;
        ЗапросБД.Текст =
            "ВЫБРАТЬ
            |   Номенклатура.Код КАК Код,
            |   Номенклатура.Наименование КАК Наименование,
            |   Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
            |   Номенклатура.ВидНоменклатуры.Наименование КАК ВидНоменклатуры,
            |   Номенклатура.НоменклатурнаяГруппа.Наименование КАК НоменклатурнаяГруппа,
            |   Номенклатура.Родитель КАК Родитель
            |ИЗ
            |   Справочник.Номенклатура КАК Номенклатура
            |ГДЕ
            |   " + УсловиеГде + "
            |УПОРЯДОЧИТЬ ПО
            |   Номенклатура.Наименование";

        Если Не ПустаяСтрока(КодФильтр) Тогда
            ЗапросБД.УстановитьПараметр("КодФильтр", "%" + КодФильтр + "%");
        КонецЕсли;
        Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
            ЗапросБД.УстановитьПараметр("НаименованиеФильтр", "%" + НаименованиеФильтр + "%");
        КонецЕсли;

        Результат = ЗапросБД.Выполнить();
        Выборка = Результат.Выбрать();

        // Построение дерева
        ГруппыПоКоду = Новый Соответствие;  // Код группы -> Структура группы
        КорневыеУзлы = Новый Массив;         // Верхний уровень дерева

        Пока Выборка.Следующий() Цикл
            // Собираем цепочку родителей (от корня к непосредственному родителю)
            ЦепочкаРодителей = Новый Массив;
            ТекущийРодитель = Выборка.Родитель;
            Пока ЗначениеЗаполнено(ТекущийРодитель) Цикл
                ЦепочкаРодителей.Вставить(0, ТекущийРодитель);
                ТекущийРодитель = ТекущийРодитель.Родитель;
            КонецЦикла;

            // Создаём/находим узлы-группы от корня вниз
            ТекущийМассивДетей = КорневыеУзлы;
            Для Каждого ЭлементЦепочки Из ЦепочкаРодителей Цикл
                КодГруппы = СокрЛП(Строка(ЭлементЦепочки.Код));
                УзелГруппы = ГруппыПоКоду.Получить(КодГруппы);
                Если УзелГруппы = Неопределено Тогда
                    УзелГруппы = Новый Структура;
                    УзелГруппы.Вставить("Код",          КодГруппы);
                    УзелГруппы.Вставить("Наименование",  СокрЛП(Строка(ЭлементЦепочки.Наименование)));
                    УзелГруппы.Вставить("ЭтоГруппа",     Истина);
                    УзелГруппы.Вставить("Дети",          Новый Массив);
                    ГруппыПоКоду.Вставить(КодГруппы, УзелГруппы);
                    ТекущийМассивДетей.Добавить(УзелГруппы);
                КонецЕсли;
                ТекущийМассивДетей = УзелГруппы.Дети;
            КонецЦикла;

            // Создаём запись материала (лист дерева)
            Материал = Новый Структура;
            Материал.Вставить("Код",                  СокрЛП(Строка(Выборка.Код)));
            Материал.Вставить("Наименование",          СокрЛП(Строка(Выборка.Наименование)));
            Материал.Вставить("ЭтоГруппа",             Ложь);
            Материал.Вставить("ЕдиницаИзмерения",      СокрЛП(Строка(Выборка.ЕдиницаИзмерения)));
            Материал.Вставить("ВидНоменклатуры",        СокрЛП(Строка(Выборка.ВидНоменклатуры)));
            Материал.Вставить("НоменклатурнаяГруппа",   СокрЛП(Строка(Выборка.НоменклатурнаяГруппа)));

            // Добавляем в Дети последней группы (или в корень если нет родителей)
            ТекущийМассивДетей.Добавить(Материал);
        КонецЦикла;

        JSON = Новый ЗаписьJSON;
        JSON.УстановитьСтроку();
        ЗаписатьJSON(JSON, КорневыеУзлы);
        JSONСтрока = JSON.Закрыть();

        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(JSONСтрока);
        Возврат Ответ;
    Исключение
        ИнформацияОбОшибке = ИнформацияОбОшибке();
        ТекстОшибки = "Описание: " + ОписаниеОшибки()
            + Символы.ПС + "Подробно: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(ТекстОшибки);
        Возврат Ответ;
    КонецПопытки;
КонецФункции
