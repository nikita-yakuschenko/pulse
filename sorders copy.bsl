Функция GetSOrders(Запрос)
    Попытка
        МассивЗаказовПоставщикам = Новый Массив;
        
        // Параметры: /get/full/{full}, /get/code/{code}, /get/contractor/{contractor}, /get/year/{year}
        ПолныйРежим = Ложь;
        ПолныйПараметр = "";
        КодФильтр = "";
        КонтрагентФильтр = "";
        ГодФильтр = "";
        Попытка
            ПолныйПараметр = НРег(СокрЛП(Строка(Запрос.ПараметрыURL["full"])));
        Исключение
            ПолныйПараметр = "";
        КонецПопытки;
        Если Не ПустаяСтрока(ПолныйПараметр) Тогда
            Если ПолныйПараметр = "1"
                Или ПолныйПараметр = "true"
                Или ПолныйПараметр = "yes"
                Или ПолныйПараметр = "full" Тогда
                ПолныйРежим = Истина;
            КонецЕсли;
        КонецЕсли;
        
        Попытка
            КодФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["code"]));
        Исключение
            КодФильтр = "";
        КонецПопытки;
        Попытка
            КонтрагентФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["contractor"]));
        Исключение
            КонтрагентФильтр = "";
        КонецПопытки;
        // Обработка спец. маркера для "+" в path
        Если Не ПустаяСтрока(КонтрагентФильтр) Тогда
            // В GET path IIS режет "+", поэтому используем замену "_plus_" -> "+"
            КонтрагентФильтр = СтрЗаменить(КонтрагентФильтр, "_plus_", "+");
            // Поддержка дефиса/минуса: "_dash_" или "_minus_" -> "-"
            КонтрагентФильтр = СтрЗаменить(КонтрагентФильтр, "_dash_", "-");
            КонтрагентФильтр = СтрЗаменить(КонтрагентФильтр, "_minus_", "-");
        КонецЕсли;
        Попытка
            ГодФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["year"]));
        Исключение
            ГодФильтр = "";
        КонецПопытки;
        
        Если ПолныйРежим И ПустаяСтрока(КодФильтр) И ПустаяСтрока(КонтрагентФильтр) Тогда
            Ответ = Новый HTTPСервисОтвет(400);
            Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
            Ответ.УстановитьТелоИзСтроки("full требует фильтр: code или contractor");
            Возврат Ответ;
        КонецЕсли;
        
        УсловиеГде = "";
        Если Не ПустаяСтрока(КодФильтр) Тогда
            УсловиеГде = "ЗаказПоставщику.Номер ПОДОБНО &КодФильтр";
        КонецЕсли;
        Если Не ПустаяСтрока(КонтрагентФильтр) Тогда
            УсловиеГде = УсловиеГде + ?(ПустаяСтрока(УсловиеГде), "", " И ")
                + "ЗаказПоставщику.Контрагент.Наименование ПОДОБНО &КонтрагентФильтр";
        КонецЕсли;
        Если Не ПустаяСтрока(ГодФильтр) Тогда
            УсловиеГде = УсловиеГде + ?(ПустаяСтрока(УсловиеГде), "", " И ")
                + "ЗаказПоставщику.Дата МЕЖДУ &ДатаНач И &ДатаКон";
        КонецЕсли;
        
        Если ПолныйРежим Тогда
            // Полный режим (открытие карточки заказа): запрос с хранилищем, ТЧ, ДопИнформация, ФайлBase64
            ЗапросБД = Новый Запрос;
            ЗапросБД.Текст = 
                "ВЫБРАТЬ
                |	ЗаказПоставщику.Ссылка КАК Ссылка,
                |	ЗаказПоставщику.Номер КАК Номер,
                |	ЗаказПоставщику.Дата КАК Дата,
                |	ЗаказПоставщику.Контрагент.Наименование КАК Контрагент,
                |	ЗаказПоставщику.Организация.Наименование КАК Организация,
                |	ЗаказПоставщику.СуммаДокумента КАК Сумма,
                |	ЗаказПоставщику.Ответственный.Наименование КАК Ответственный,
                |	ХранилищеДополнительнойИнформации.Ссылка КАК СсылкаХранилища,
                |	ХранилищеДополнительнойИнформации.ТекстФайла КАК ТекстФайла,
                |	ХранилищеДополнительнойИнформации.Представление КАК ПредставлениеХранилища,
                |	ХранилищеДополнительнойИнформации.ВидДанных.Порядок КАК ПорядокВидДанных,
                |	ХранилищеДополнительнойИнформации.ВидДанных.Ссылка КАК СсылкаВидДанных,
                |	ХранилищеДополнительнойИнформации.Хранилище КАК ХранилищеДанные,
                |	ХранилищеДополнительнойИнформации.ИмяФайла КАК ИмяФайла,
                |	ХранилищеДополнительнойИнформации.Объект КАК ОбъектХранилища
                |ИЗ
                |	Документ.ЗаказПоставщику КАК ЗаказПоставщику
                |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХранилищеДополнительнойИнформации КАК ХранилищеДополнительнойИнформации
                |		ПО ЗаказПоставщику.Ссылка = ХранилищеДополнительнойИнформации.Объект"
                + ?(ПустаяСтрока(УсловиеГде), "", "
                |ГДЕ
                |   " + УсловиеГде);
            
            Если Не ПустаяСтрока(КодФильтр) Тогда
                ЗапросБД.УстановитьПараметр("КодФильтр", "%" + КодФильтр + "%");
            КонецЕсли;
            Если Не ПустаяСтрока(КонтрагентФильтр) Тогда
                ЗапросБД.УстановитьПараметр("КонтрагентФильтр", "%" + КонтрагентФильтр + "%");
            КонецЕсли;
            Если Не ПустаяСтрока(ГодФильтр) Тогда
                ГодФильтрЧисло = Число(ГодФильтр);
                Если СтрДлина(ГодФильтр) = 2 Тогда
                    ГодФильтрЧисло = 2000 + ГодФильтрЧисло;
                КонецЕсли;
                ЗапросБД.УстановитьПараметр("ДатаНач", Дата(ГодФильтрЧисло, 1, 1));
                ЗапросБД.УстановитьПараметр("ДатаКон", Дата(ГодФильтрЧисло, 12, 31, 23, 59, 59));
            КонецЕсли;

            Результат = ЗапросБД.Выполнить();
            Выборка = Результат.Выбрать();

            ПредыдущаяСсылкаЗаказа = Неопределено;
            ЗаказПоставщику = Неопределено;

            Пока Выборка.Следующий() Цикл
            // Смена заказа: сохраняем предыдущий в массив и начинаем новый
            Если ПредыдущаяСсылкаЗаказа <> Неопределено И Выборка.Ссылка <> ПредыдущаяСсылкаЗаказа Тогда
                МассивЗаказовПоставщикам.Добавить(ЗаказПоставщику);
            КонецЕсли;
            ЗаказТолькоЧтоСоздан = Ложь;
            Если ЗаказПоставщику = Неопределено Или Выборка.Ссылка <> ПредыдущаяСсылкаЗаказа Тогда
                ПредыдущаяСсылкаЗаказа = Выборка.Ссылка;
                ЗаказПоставщику = Новый Структура;
                ДопИнформация = Новый Массив;
                ЗаказТолькоЧтоСоздан = Истина;

                ЗаказПоставщику.Вставить("Ссылка", ?(Выборка.Ссылка = Неопределено, "", Строка(Выборка.Ссылка)));
                Если Выборка.Дата = Неопределено Тогда
                    ЗаказПоставщику.Вставить("Дата", "");
                Иначе
                    ЗаказПоставщику.Вставить("Дата", Строка(Выборка.Дата));
                КонецЕсли;

                Если Выборка.Номер = Неопределено Тогда
                    ЗаказПоставщику.Вставить("Номер", "");
                Иначе
                    ЗаказПоставщику.Вставить("Номер", Строка(Выборка.Номер));
                КонецЕсли;

                Если Выборка.Контрагент = Неопределено Тогда
                    ЗаказПоставщику.Вставить("Контрагент", "");
                Иначе
                    ЗаказПоставщику.Вставить("Контрагент", Строка(Выборка.Контрагент));
                КонецЕсли;

                Если Выборка.Организация = Неопределено Тогда
                    ЗаказПоставщику.Вставить("Организация", "");
                Иначе
                    ЗаказПоставщику.Вставить("Организация", Строка(Выборка.Организация));
                КонецЕсли;

                Если Выборка.Ответственный = Неопределено Тогда
                    ЗаказПоставщику.Вставить("Ответственный", "");
                Иначе
                    ЗаказПоставщику.Вставить("Ответственный", Строка(Выборка.Ответственный));
                КонецЕсли;

                Если Выборка.Сумма = Неопределено Тогда
                    ЗаказПоставщику.Вставить("Сумма", "");
                Иначе
                    ЗаказПоставщику.Вставить("Сумма", Число(Выборка.Сумма));
                КонецЕсли;
            КонецЕсли;

            // Данные из хранилища дополнительной информации (если есть) — все поля из запроса
            Если ЗначениеЗаполнено(Выборка.СсылкаХранилища) Тогда
                ЭлементДоп = Новый Структура;
                ЭлементДоп.Вставить("СсылкаХранилища", Строка(Выборка.СсылкаХранилища));
                ЭлементДоп.Вставить("Объект", ?(Выборка.ОбъектХранилища = Неопределено, "", Строка(Выборка.ОбъектХранилища)));
                ЭлементДоп.Вставить("Представление", ?(Выборка.ПредставлениеХранилища = Неопределено, "", Строка(Выборка.ПредставлениеХранилища)));
                ЭлементДоп.Вставить("ИмяФайла", ?(Выборка.ИмяФайла = Неопределено, "", Строка(Выборка.ИмяФайла)));
                ЭлементДоп.Вставить("ТекстФайла", ?(Выборка.ТекстФайла = Неопределено, "", Строка(Выборка.ТекстФайла)));
                ЭлементДоп.Вставить("ПорядокВидДанных", ?(Выборка.ПорядокВидДанных = Неопределено, 0, Выборка.ПорядокВидДанных));
                ЭлементДоп.Вставить("СсылкаВидДанных", ?(ЗначениеЗаполнено(Выборка.СсылкаВидДанных), Строка(Выборка.СсылкаВидДанных), ""));
                ЭлементДоп.Вставить("ЕстьВложение", ЗначениеЗаполнено(Выборка.СсылкаХранилища));
                ЭлементДоп.Вставить("ИдентификаторХранилища", Строка(Выборка.СсылкаХранилища.УникальныйИдентификатор()));
                // При full — содержимое файла в Base64. Сначала из выборки; если пусто (файловое хранилище) — по ссылке на запись.
                Если ПолныйРежим И ЗначениеЗаполнено(Выборка.СсылкаХранилища) Тогда
                    ДвоичныеДанные = Неопределено;
                    Если ЗначениеЗаполнено(Выборка.ХранилищеДанные) Тогда
                        Попытка
                            ДвоичныеДанные = Выборка.ХранилищеДанные.Получить();
                        Исключение
                        КонецПопытки;
                    КонецЕсли;
                    Если ДвоичныеДанные = Неопределено Тогда
                        ДвоичныеДанные = ПолучитьДвоичныеДанныеИзХранилищаПоСсылке(Выборка.СсылкаХранилища);
                    КонецЕсли;
                    ЭлементДоп.Вставить("ФайлBase64", ДвоичныеДанныеВBase64(ДвоичныеДанные));
                КонецЕсли;
                ДопИнформация.Добавить(ЭлементДоп);
            КонецЕсли;

            ЗаказПоставщику.Вставить("ДопИнформация", ДопИнформация);

            // Полный режим (ТЧ, комментарий) — один раз на заказ
            Если ПолныйРежим И ЗаказТолькоЧтоСоздан Тогда
                ОбъектЗаказ = Выборка.Ссылка.ПолучитьОбъект();
                
                Товары = Новый Массив;
                Для Каждого СтрокаТЧ Из ОбъектЗаказ.Товары Цикл
                    Стр = Новый Структура;
                    Стр.Вставить("НомерСтроки", Строка(СтрокаТЧ.НомерСтроки));
                    Стр.Вставить("Номенклатура", ?(ЗначениеЗаполнено(СтрокаТЧ.Номенклатура), Строка(СтрокаТЧ.Номенклатура.Наименование), ""));
                    Стр.Вставить("Код", ?(ЗначениеЗаполнено(СтрокаТЧ.Номенклатура), Строка(СтрокаТЧ.Номенклатура.Код), ""));
                    Стр.Вставить("ХарактеристикаНоменклатуры", ?(ЗначениеЗаполнено(СтрокаТЧ.ХарактеристикаНоменклатуры), Строка(СтрокаТЧ.ХарактеристикаНоменклатуры.Наименование), ""));
                    Стр.Вставить("ЕдиницаИзмерения", ?(ЗначениеЗаполнено(СтрокаТЧ.ЕдиницаИзмерения), Строка(СтрокаТЧ.ЕдиницаИзмерения.Наименование), ""));
                    Стр.Вставить("ЕдиницаИзмеренияМест", ?(ЗначениеЗаполнено(СтрокаТЧ.ЕдиницаИзмеренияМест), Строка(СтрокаТЧ.ЕдиницаИзмеренияМест.Наименование), ""));
                    Стр.Вставить("Количество", СтрокаТЧ.Количество);
                    Стр.Вставить("КоличествоМест", СтрокаТЧ.КоличествоМест);
                    Стр.Вставить("Коэффициент", СтрокаТЧ.Коэффициент);
                    Стр.Вставить("Цена", СтрокаТЧ.Цена);
                    Стр.Вставить("Сумма", СтрокаТЧ.Сумма);
                    Стр.Вставить("СтавкаНДС", Строка(СтрокаТЧ.СтавкаНДС));
                    Стр.Вставить("СуммаНДС", СтрокаТЧ.СуммаНДС);
                    Стр.Вставить("ПлановаяСебестоимость", СтрокаТЧ.ПлановаяСебестоимость);
                    Товары.Добавить(Стр);
                КонецЦикла;
                
                Услуги = Новый Массив;
                Для Каждого СтрокаТЧ Из ОбъектЗаказ.Услуги Цикл
                    Стр = Новый Структура;
                    Стр.Вставить("НомерСтроки", Строка(СтрокаТЧ.НомерСтроки));
                    Стр.Вставить("Содержание", Строка(СтрокаТЧ.Содержание));
                    Стр.Вставить("Номенклатура", ?(ЗначениеЗаполнено(СтрокаТЧ.Номенклатура), Строка(СтрокаТЧ.Номенклатура.Наименование), ""));
                    Стр.Вставить("Код", ?(ЗначениеЗаполнено(СтрокаТЧ.Номенклатура), Строка(СтрокаТЧ.Номенклатура.Код), ""));
                    Стр.Вставить("Количество", СтрокаТЧ.Количество);
                    Стр.Вставить("Цена", СтрокаТЧ.Цена);
                    Стр.Вставить("Сумма", СтрокаТЧ.Сумма);
                    Стр.Вставить("СтавкаНДС", Строка(СтрокаТЧ.СтавкаНДС));
                    Стр.Вставить("СуммаНДС", СтрокаТЧ.СуммаНДС);
                    Услуги.Добавить(Стр);
                КонецЦикла;
                
                Оборудование = Новый Массив;
                Для Каждого СтрокаТЧ Из ОбъектЗаказ.Оборудование Цикл
                    Стр = Новый Структура;
                    Стр.Вставить("НомерСтроки", Строка(СтрокаТЧ.НомерСтроки));
                    Стр.Вставить("Номенклатура", ?(ЗначениеЗаполнено(СтрокаТЧ.Номенклатура), Строка(СтрокаТЧ.Номенклатура.Наименование), ""));
                    Стр.Вставить("Код", ?(ЗначениеЗаполнено(СтрокаТЧ.Номенклатура), Строка(СтрокаТЧ.Номенклатура.Код), ""));
                    Стр.Вставить("ХарактеристикаНоменклатуры", ?(ЗначениеЗаполнено(СтрокаТЧ.ХарактеристикаНоменклатуры), Строка(СтрокаТЧ.ХарактеристикаНоменклатуры.Наименование), ""));
                    Стр.Вставить("ЕдиницаИзмерения", ?(ЗначениеЗаполнено(СтрокаТЧ.ЕдиницаИзмерения), Строка(СтрокаТЧ.ЕдиницаИзмерения.Наименование), ""));
                    Стр.Вставить("ЕдиницаИзмеренияМест", ?(ЗначениеЗаполнено(СтрокаТЧ.ЕдиницаИзмеренияМест), Строка(СтрокаТЧ.ЕдиницаИзмеренияМест.Наименование), ""));
                    Стр.Вставить("Количество", СтрокаТЧ.Количество);
                    Стр.Вставить("КоличествоМест", СтрокаТЧ.КоличествоМест);
                    Стр.Вставить("Коэффициент", СтрокаТЧ.Коэффициент);
                    Стр.Вставить("Цена", СтрокаТЧ.Цена);
                    Стр.Вставить("Сумма", СтрокаТЧ.Сумма);
                    Стр.Вставить("СтавкаНДС", Строка(СтрокаТЧ.СтавкаНДС));
                    Оборудование.Добавить(Стр);
                КонецЦикла;
                
                Материалы = Новый Массив;
                Для Каждого СтрокаТЧ Из ОбъектЗаказ.Материалы Цикл
                    Стр = Новый Структура;
                    Стр.Вставить("НомерСтроки", Строка(СтрокаТЧ.НомерСтроки));
                    Стр.Вставить("Номенклатура", ?(ЗначениеЗаполнено(СтрокаТЧ.Номенклатура), Строка(СтрокаТЧ.Номенклатура.Наименование), ""));
                    Стр.Вставить("Код", ?(ЗначениеЗаполнено(СтрокаТЧ.Номенклатура), Строка(СтрокаТЧ.Номенклатура.Код), ""));
                    Стр.Вставить("ХарактеристикаНоменклатуры", ?(ЗначениеЗаполнено(СтрокаТЧ.ХарактеристикаНоменклатуры), Строка(СтрокаТЧ.ХарактеристикаНоменклатуры.Наименование), ""));
                    Стр.Вставить("ЕдиницаИзмерения", ?(ЗначениеЗаполнено(СтрокаТЧ.ЕдиницаИзмерения), Строка(СтрокаТЧ.ЕдиницаИзмерения.Наименование), ""));
                    Стр.Вставить("ЕдиницаИзмеренияМест", ?(ЗначениеЗаполнено(СтрокаТЧ.ЕдиницаИзмеренияМест), Строка(СтрокаТЧ.ЕдиницаИзмеренияМест.Наименование), ""));
                    Стр.Вставить("Количество", СтрокаТЧ.Количество);
                    Стр.Вставить("КоличествоМест", СтрокаТЧ.КоличествоМест);
                    Стр.Вставить("Коэффициент", СтрокаТЧ.Коэффициент);
                    Стр.Вставить("Цена", СтрокаТЧ.Цена);
                    Стр.Вставить("Сумма", СтрокаТЧ.Сумма);
                    Материалы.Добавить(Стр);
                КонецЦикла;
                
                ВозвратнаяТара = Новый Массив;
                Для Каждого СтрокаТЧ Из ОбъектЗаказ.ВозвратнаяТара Цикл
                    Стр = Новый Структура;
                    Стр.Вставить("НомерСтроки", Строка(СтрокаТЧ.НомерСтроки));
                    Стр.Вставить("Номенклатура", ?(ЗначениеЗаполнено(СтрокаТЧ.Номенклатура), Строка(СтрокаТЧ.Номенклатура.Наименование), ""));
                    Стр.Вставить("Код", ?(ЗначениеЗаполнено(СтрокаТЧ.Номенклатура), Строка(СтрокаТЧ.Номенклатура.Код), ""));
                    Стр.Вставить("Количество", СтрокаТЧ.Количество);
                    Стр.Вставить("Цена", СтрокаТЧ.Цена);
                    Стр.Вставить("Сумма", СтрокаТЧ.Сумма);
                    ВозвратнаяТара.Добавить(Стр);
                КонецЦикла;
                
                ЗаказПоставщику.Вставить("Товары", Товары);
                ЗаказПоставщику.Вставить("Услуги", Услуги);
                ЗаказПоставщику.Вставить("Оборудование", Оборудование);
                ЗаказПоставщику.Вставить("Материалы", Материалы);
                ЗаказПоставщику.Вставить("ВозвратнаяТара", ВозвратнаяТара);
                
                // Комментарий из шапки документа
                Если ОбъектЗаказ.Комментарий = Неопределено Тогда
                    ЗаказПоставщику.Вставить("Комментарий", "");
                Иначе
                    ЗаказПоставщику.Вставить("Комментарий", Строка(ОбъектЗаказ.Комментарий));
                КонецЕсли;
            КонецЕсли;
            КонецЦикла;

            // Последний заказ в выборке
            Если ЗаказПоставщику <> Неопределено Тогда
                МассивЗаказовПоставщикам.Добавить(ЗаказПоставщику);
            КонецЕсли;
        Иначе
            // Режим списка (/get/list или с фильтрами без full): только основные поля, без хранилища и ТЧ — быстрый ответ
            ЗапросБД = Новый Запрос;
            ЗапросБД.Текст = 
                "ВЫБРАТЬ
                |	ЗаказПоставщику.Дата КАК Дата,
                |	ЗаказПоставщику.Номер КАК Номер,
                |	ЗаказПоставщику.Контрагент.Наименование КАК Контрагент,
                |	ЗаказПоставщику.Организация.Наименование КАК Организация,
                |	ЗаказПоставщику.Ответственный.Наименование КАК Ответственный,
                |	ЗаказПоставщику.СуммаДокумента КАК Сумма
                |ИЗ
                |	Документ.ЗаказПоставщику КАК ЗаказПоставщику"
                + ?(ПустаяСтрока(УсловиеГде), "", "
                |ГДЕ
                |   " + УсловиеГде);
            
            Если Не ПустаяСтрока(КодФильтр) Тогда
                ЗапросБД.УстановитьПараметр("КодФильтр", "%" + КодФильтр + "%");
            КонецЕсли;
            Если Не ПустаяСтрока(КонтрагентФильтр) Тогда
                ЗапросБД.УстановитьПараметр("КонтрагентФильтр", "%" + КонтрагентФильтр + "%");
            КонецЕсли;
            Если Не ПустаяСтрока(ГодФильтр) Тогда
                ГодФильтрЧисло = Число(ГодФильтр);
                Если СтрДлина(ГодФильтр) = 2 Тогда
                    ГодФильтрЧисло = 2000 + ГодФильтрЧисло;
                КонецЕсли;
                ЗапросБД.УстановитьПараметр("ДатаНач", Дата(ГодФильтрЧисло, 1, 1));
                ЗапросБД.УстановитьПараметр("ДатаКон", Дата(ГодФильтрЧисло, 12, 31, 23, 59, 59));
            КонецЕсли;

            Результат = ЗапросБД.Выполнить();
            Выборка = Результат.Выбрать();

            Пока Выборка.Следующий() Цикл
                ЗаказПоставщику = Новый Структура;
                ЗаказПоставщику.Вставить("Дата", ?(Выборка.Дата = Неопределено, "", Строка(Выборка.Дата)));
                ЗаказПоставщику.Вставить("Номер", ?(Выборка.Номер = Неопределено, "", Строка(Выборка.Номер)));
                ЗаказПоставщику.Вставить("Контрагент", ?(Выборка.Контрагент = Неопределено, "", Строка(Выборка.Контрагент)));
                ЗаказПоставщику.Вставить("Организация", ?(Выборка.Организация = Неопределено, "", Строка(Выборка.Организация)));
                ЗаказПоставщику.Вставить("Ответственный", ?(Выборка.Ответственный = Неопределено, "", Строка(Выборка.Ответственный)));
                ЗаказПоставщику.Вставить("Сумма", ?(Выборка.Сумма = Неопределено, "", Число(Выборка.Сумма)));
                МассивЗаказовПоставщикам.Добавить(ЗаказПоставщику);
            КонецЦикла;
        КонецЕсли;

        JSON = Новый ЗаписьJSON;
        JSON.УстановитьСтроку();
        ЗаписатьJSON(JSON, МассивЗаказовПоставщикам);
        JSONСтрока = JSON.Закрыть();

        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(JSONСтрока);
        Возврат Ответ;
    Исключение
        ОписаниеОшибки = ОписаниеОшибки();
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(ОписаниеОшибки);
        Возврат Ответ;
    КонецПопытки;
КонецФункции

// Возвращает двоичные данные из записи ХранилищеДополнительнойИнформации по ссылке.
// Через запрос (как в GetSOrderFile) — надёжно при любом типе хранилища.
Функция ПолучитьДвоичныеДанныеИзХранилищаПоСсылке(СсылкаХранилища)
    ДвоичныеДанные = Неопределено;
    Попытка
        ЗапросБД = Новый Запрос;
        ЗапросБД.Текст =
            "ВЫБРАТЬ
            |	ХранилищеДополнительнойИнформации.Хранилище КАК Хранилище
            |ИЗ
            |	Справочник.ХранилищеДополнительнойИнформации КАК ХранилищеДополнительнойИнформации
            |ГДЕ
            |	ХранилищеДополнительнойИнформации.Ссылка = &Ссылка";
        ЗапросБД.УстановитьПараметр("Ссылка", СсылкаХранилища);
        Результат = ЗапросБД.Выполнить();
        Выборка = Результат.Выбрать();
        Если Не Выборка.Следующий() Тогда
            Возврат Неопределено;
        КонецЕсли;
        ХранилищеЗначения = Выборка.Хранилище;
        Если Не ЗначениеЗаполнено(ХранилищеЗначения) Тогда
            Возврат Неопределено;
        КонецЕсли;
        ЗначениеИзХранилища = ХранилищеЗначения.Получить();
        // По подсказке с forum.mista.ru/topic/501041: Получить() может вернуть не ДвоичныеДанные
        Если ТипЗнч(ЗначениеИзХранилища) = Тип("ДвоичныеДанные") Тогда
            ДвоичныеДанные = ЗначениеИзХранилища;
        Иначе
            // Обходной путь: тип с методом Записать(Путь) — пишем во временный файл и читаем как ДвоичныеДанные
            Попытка
                ВременныйФайл = ПолучитьИмяВременногоФайла();
                ЗначениеИзХранилища.Записать(ВременныйФайл);
                ДвоичныеДанные = Новый ДвоичныеДанные(ВременныйФайл);
                УдалитьФайлы(ВременныйФайл);
            Исключение
                ДвоичныеДанные = Неопределено;
            КонецПопытки;
        КонецЕсли;
    Исключение
        Возврат Неопределено;
    КонецПопытки;
    Возврат ДвоичныеДанные;
КонецФункции

// Кодирует двоичные данные в строку Base64 (для выдачи файла в JSON при full).
// Варианты: Base64Строка платформы → ОбщегоНазначения → автономное кодирование через поток.
Функция ДвоичныеДанныеВBase64(ДвоичныеДанные)
    Если ДвоичныеДанные = Неопределено Тогда
        Возврат "";
    КонецЕсли;
    Попытка
        Возврат Base64Строка(ДвоичныеДанные);
    Исключение
        Попытка
            Возврат ОбщегоНазначения.ДвоичныеДанныеВСтрокуBase64(ДвоичныеДанные);
        Исключение
            Попытка
                Возврат ДвоичныеДанныеВBase64ПоБайтам(ДвоичныеДанные);
            Исключение
                Возврат "";
            КонецПопытки;
        КонецПопытки;
    КонецПопытки;
КонецФункции

// Автономное кодирование Base64 по байтам (без внешних функций).
Функция ДвоичныеДанныеВBase64ПоБайтам(ДвоичныеДанные)
    Попытка
        Поток = ДвоичныеДанные.ОткрытьПотокДляЧтения();
    Исключение
        Возврат "";
    КонецПопытки;
    Попытка
        Размер = ДвоичныеДанные.Размер;
    Исключение
        Возврат "";
    КонецПопытки;
    Если Размер = 0 Тогда
        Возврат "";
    КонецЕсли;
    Алфавит = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
    Результат = "";
    ЧтениеД = Новый ЧтениеДанных(Поток);
    Смещение = 0;
    Пока Смещение < Размер Цикл
        Байт0 = 0;
        Байт1 = 0;
        Байт2 = 0;
        Попытка
            Байт0 = ЧтениеД.ПрочитатьЦелое8(Истина);
            Смещение = Смещение + 1;
        Исключение
        КонецПопытки;
        Если Смещение < Размер Тогда
            Попытка
                Байт1 = ЧтениеД.ПрочитатьЦелое8(Истина);
                Смещение = Смещение + 1;
            Исключение
            КонецПопытки;
        КонецЕсли;
        Если Смещение < Размер Тогда
            Попытка
                Байт2 = ЧтениеД.ПрочитатьЦелое8(Истина);
                Смещение = Смещение + 1;
            Исключение
            КонецПопытки;
        КонецЕсли;
        Н = Байт0 * 65536 + Байт1 * 256 + Байт2;
        Результат = Результат + Сред(Алфавит, Цел(Н / 262144) + 1, 1) + Сред(Алфавит, Цел(Н / 4096) % 64 + 1, 1)
            + Сред(Алфавит, Цел(Н / 64) % 64 + 1, 1) + Сред(Алфавит, Н % 64 + 1, 1);
    КонецЦикла;
    Попытка
        ЧтениеД.Закрыть();
    Исключение
    КонецПопытки;
    Остаток = Размер % 3;
    Если Остаток = 1 Тогда
        Результат = Лев(Результат, СтрДлина(Результат) - 2) + "==";
    ИначеЕсли Остаток = 2 Тогда
        Результат = Лев(Результат, СтрДлина(Результат) - 1) + "=";
    КонецЕсли;
    Возврат Результат;
КонецФункции

// Возвращает файл из хранилища дополнительной информации по идентификатору записи.
// URL: например /get/file/{id}, где id = ИдентификаторХранилища из элемента ДопИнформация.
Функция GetSOrderFile(Запрос)
    Попытка
        ИдентификаторСтрока = "";
        Попытка
            ИдентификаторСтрока = СокрЛП(Строка(Запрос.ПараметрыURL["id"]));
        Исключение
        КонецПопытки;
        Если ПустаяСтрока(ИдентификаторСтрока) Тогда
            Ответ = Новый HTTPСервисОтвет(400);
            Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
            Ответ.УстановитьТелоИзСтроки("Параметр id обязателен");
            Возврат Ответ;
        КонецЕсли;

        Ссылка = Справочники.ХранилищеДополнительнойИнформации.ПолучитьСсылку(Новый УникальныйИдентификатор(ИдентификаторСтрока));
        ЗапросБД = Новый Запрос;
        ЗапросБД.Текст =
            "ВЫБРАТЬ
            |	ХранилищеДополнительнойИнформации.Хранилище КАК Хранилище,
            |	ХранилищеДополнительнойИнформации.ИмяФайла КАК ИмяФайла,
            |	ХранилищеДополнительнойИнформации.Ссылка,
            |	ХранилищеДополнительнойИнформации.ВидДанных.Ссылка,
            |	ХранилищеДополнительнойИнформации.ВидДанных.Порядок,
            |	ХранилищеДополнительнойИнформации.Хранилище КАК Хранилище1
            |ИЗ
            |	Справочник.ХранилищеДополнительнойИнформации КАК ХранилищеДополнительнойИнформации
            |ГДЕ
            |	ХранилищеДополнительнойИнформации.Ссылка = &Ссылка";
        ЗапросБД.УстановитьПараметр("Ссылка", Ссылка);
        Результат = ЗапросБД.Выполнить();
        Выборка = Результат.Выбрать();
        Если Не Выборка.Следующий() Тогда
            Ответ = Новый HTTPСервисОтвет(404);
            Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
            Ответ.УстановитьТелоИзСтроки("Файл не найден");
            Возврат Ответ;
        КонецЕсли;

        ХранилищеЗначения = Выборка.Хранилище;
        Если Не ЗначениеЗаполнено(ХранилищеЗначения) Тогда
            Ответ = Новый HTTPСервисОтвет(404);
            Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
            Ответ.УстановитьТелоИзСтроки("Вложение пусто");
            Возврат Ответ;
        КонецЕсли;

        ДвоичныеДанные = ХранилищеЗначения.Получить();
        ИмяФайла = ?(Выборка.ИмяФайла = Неопределено Или ПустаяСтрока(Выборка.ИмяФайла), "file", Строка(Выборка.ИмяФайла));
        // Убираем недопустимые символы из имени файла в заголовке
        ИмяФайла = СтрЗаменить(ИмяФайла, Символ(0), "");
        Если СтрДлина(ИмяФайла) > 200 Тогда
            ИмяФайла = Лев(ИмяФайла, 200);
        КонецЕсли;

        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.Заголовки.Вставить("Content-Type", "application/octet-stream");
        Ответ.Заголовки.Вставить("Content-Disposition", "attachment; filename=""" + ИмяФайла + """");
        Ответ.УстановитьТелоИзДвоичныхДанных(ДвоичныеДанные);
        Возврат Ответ;
    Исключение
        ОписаниеОшибки = ОписаниеОшибки();
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(ОписаниеОшибки);
        Возврат Ответ;
    КонецПопытки;
КонецФункции
