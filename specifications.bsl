Функция GetSpecifications(Запрос)
    
    Попытка
        // Параметры из URL: /get/name/{name}, /get/code/{code}, /get/material/{material}, /get/full/{full}, /get/year/{year}, /get/month/{month}
        НаименованиеФильтр = "";
        КодФильтр = "";
        МатериалФильтр = "";
        ГодФильтр = "";
        МесяцФильтр = "";
        ПолныйРежим = Ложь;
        ПолныйПараметр = "";
        Попытка
            НаименованиеФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["name"]));
        Исключение
            НаименованиеФильтр = "";
        КонецПопытки;
        Попытка
            КодФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["code"]));
        Исключение
            КодФильтр = "";
        КонецПопытки;
        Попытка
            МатериалФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["material"]));
        Исключение
            МатериалФильтр = "";
        КонецПопытки;
        Попытка
            ГодФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["year"]));
        Исключение
            ГодФильтр = "";
        КонецПопытки;
        Попытка
            МесяцФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["month"]));
        Исключение
            МесяцФильтр = "";
        КонецПопытки;
        Попытка
            ПолныйПараметр = НРег(СокрЛП(Строка(Запрос.ПараметрыURL["full"])));
        Исключение
            ПолныйПараметр = "";
        КонецПопытки;
        Если Не ПустаяСтрока(ПолныйПараметр) Тогда
            Если ПолныйПараметр = "1" Или ПолныйПараметр = "true" Или ПолныйПараметр = "yes" Или ПолныйПараметр = "full" Тогда
                ПолныйРежим = Истина;
            КонецЕсли;
        КонецЕсли;
        
        // Если в URL параметра нет, пробуем взять из тела запроса (JSON: {"name":"...", "code":"..."})
        Если ПустаяСтрока(НаименованиеФильтр) Или ПустаяСтрока(КодФильтр) Тогда
            Попытка
                ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
                Если Не ПустаяСтрока(ТелоЗапроса) Тогда
                    ЧтениеJSON = Новый ЧтениеJSON;
                    ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
                    ДанныеТела = ПрочитатьJSON(ЧтениеJSON);
                    Если ТипЗнч(ДанныеТела) = Тип("Структура") Тогда
                        Если ДанныеТела.Свойство("name") Тогда
                            НаименованиеФильтр = СокрЛП(Строка(ДанныеТела["name"]));
                        КонецЕсли;
                        Если ДанныеТела.Свойство("code") Тогда
                            КодФильтр = СокрЛП(Строка(ДанныеТела["code"]));
                        КонецЕсли;
                        Если ДанныеТела.Свойство("year") Тогда
                            ГодФильтр = СокрЛП(Строка(ДанныеТела["year"]));
                        КонецЕсли;
                        Если ДанныеТела.Свойство("month") Тогда
                            МесяцФильтр = СокрЛП(Строка(ДанныеТела["month"]));
                        КонецЕсли;
                    КонецЕсли;
                КонецЕсли;
            Исключение
                // Игнорируем ошибки разбора тела
            КонецПопытки;
        КонецЕсли;
        // Обработка спец. маркера для "/" в path
        Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
            // В GET path IIS режет "%2F", поэтому используем замену "_slash_" -> "/"
            НаименованиеФильтр = СтрЗаменить(НаименованиеФильтр, "_slash_", "/");
        КонецЕсли;
        Если Не ПустаяСтрока(МатериалФильтр) Тогда
            // В GET path IIS режет "%2F", поэтому используем замену "_slash_" -> "/"
            МатериалФильтр = СтрЗаменить(МатериалФильтр, "_slash_", "/");
        КонецЕсли;
        
        // Полный список материалов: при full+(name или code) — все материалы; при material — только совпавшие (массив по сути full для этого материала)
        ПоказыватьПолныйСписокМатериалов = (ПолныйРежим И (Не ПустаяСтрока(НаименованиеФильтр) Или Не ПустаяСтрока(КодФильтр))) Или Не ПустаяСтрока(МатериалФильтр);
        Если ПолныйРежим И ПустаяСтрока(НаименованиеФильтр) И ПустаяСтрока(КодФильтр) И ПустаяСтрока(МатериалФильтр) Тогда
            Ответ = Новый HTTPСервисОтвет(400);
            Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
            Ответ.УстановитьТелоИзСтроки("full требует параметр name, code или material");
            Возврат Ответ;
        КонецЕсли;
        Если Не ПустаяСтрока(МесяцФильтр) И ПустаяСтрока(ГодФильтр) Тогда
            Ответ = Новый HTTPСервисОтвет(400);
            Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
            Ответ.УстановитьТелоИзСтроки("month требует параметр year");
            Возврат Ответ;
        КонецЕсли;
        
        // material+full: только спецификации, где встречается материал, но в ответе — полный список материалов по каждой
        МатериалИПолный = Не ПустаяСтрока(МатериалФильтр) И ПолныйРежим;
        
        // 1. Получаем спецификации и комплектующие через запрос
        УсловиеГде = "НЕ СпецификацииНоменклатуры.ЭтоГруппа И НЕ СпецификацииНоменклатуры.ПометкаУдаления";
        Если Не ПустаяСтрока(КодФильтр) Тогда
            УсловиеГде = УсловиеГде + " И СпецификацииНоменклатуры.Код ПОДОБНО &КодФильтр";
        КонецЕсли;
        Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
            УсловиеГде = УсловиеГде + " И СпецификацииНоменклатуры.Наименование ПОДОБНО &НаименованиеФильтр";
        КонецЕсли;
        Если Не ПустаяСтрока(МатериалФильтр) Тогда
            Если МатериалИПолный Тогда
                // Ограничиваем набор спецификаций теми, где есть такой материал; по строкам фильтр не ставим — вернём все материалы
                УсловиеГде = УсловиеГде + " И СпецификацииНоменклатуры.Ссылка В (ВЫБРАТЬ РАЗЛИЧНЫЕ КомплектующиеПод.Ссылка ИЗ Справочник.СпецификацииНоменклатуры.ИсходныеКомплектующие КАК КомплектующиеПод ГДЕ КомплектующиеПод.Номенклатура.Код ПОДОБНО &МатериалФильтр ИЛИ КомплектующиеПод.Номенклатура.Наименование ПОДОБНО &МатериалФильтр)";
            Иначе
                // Только строки материалов, совпавших по фильтру
                УсловиеГде = УсловиеГде + " И (Комплектующие.Номенклатура.Код ПОДОБНО &МатериалФильтр"
                    + " ИЛИ Комплектующие.Номенклатура.Наименование ПОДОБНО &МатериалФильтр)";
            КонецЕсли;
        КонецЕсли;
        // Фильтр по дате поставки: year и опционально month (month только вместе с year); параметры ДатаНач/ДатаКон задаются ниже
        Если Не ПустаяСтрока(ГодФильтр) Тогда
            УсловиеГде = УсловиеГде + " И СпецификацииНоменклатуры.Ссылка В (ВЫБРАТЬ РАЗЛИЧНЫЕ ЭтапыПоставок.Ссылка ИЗ Справочник.СпецификацииНоменклатуры.ЭтапыПоставок КАК ЭтапыПоставок ГДЕ ЭтапыПоставок.ДатаПоставкиПлан МЕЖДУ &ДатаНач И &ДатаКон)";
        КонецЕсли;
        
        // Получаем даты поставки (берем первую/минимальную по этапам)
        ЗапросДаты = Новый Запрос;
        ЗапросДаты.Текст =
            "ВЫБРАТЬ
            |   ЭтапыПоставок.Ссылка КАК СпецификацияСсылка,
            |   МИНИМУМ(ЭтапыПоставок.ДатаПоставкиПлан) КАК ДатаПоставки
            |ИЗ
            |   Справочник.СпецификацииНоменклатуры.ЭтапыПоставок КАК ЭтапыПоставок
            |СГРУППИРОВАТЬ ПО
            |   ЭтапыПоставок.Ссылка";
        
        ДатыПоставкиПоСсылке = Новый Соответствие;
        РезультатДаты = ЗапросДаты.Выполнить();
        ВыборкаДаты = РезультатДаты.Выбрать();
        Пока ВыборкаДаты.Следующий() Цикл
            ДатыПоставкиПоСсылке.Вставить(ВыборкаДаты.СпецификацияСсылка, ВыборкаДаты.ДатаПоставки);
        КонецЦикла;
        
        ЗапросБД = Новый Запрос;
        ЗапросБД.Текст =
            "ВЫБРАТЬ
            |   СпецификацииНоменклатуры.Ссылка КАК СпецификацияСсылка,
            |   СпецификацииНоменклатуры.Код КАК КодСпецификации,
            |   СпецификацииНоменклатуры.ДатаУтверждения КАК ДатаУтвержденияСпецификации,
            |   СпецификацииНоменклатуры.Ответственный.Наименование КАК ОтветственныйСпецификации,
            |   СпецификацииНоменклатуры.Наименование КАК Наименование,
            |   ЕСТЬNULL(СпецификацииНоменклатуры.СтоимостьРабот, 0) КАК СтоимостьРабот,
            |   ЕСТЬNULL(СпецификацииНоменклатуры.СтоимостьТранспорт, 0) КАК СтоимостьТранспорт,
            |   ЕСТЬNULL(СпецификацииНоменклатуры.СтоимостьНакладные, 0) КАК СтоимостьНакладные,
            |   ЕСТЬNULL(СпецификацииНоменклатуры.СтоимостьАрендаСпецТехники, 0) КАК СтоимостьАрендаСпецТехники,
            |   ЕСТЬNULL(СпецификацииНоменклатуры.СтоимостьТехнологическиеПрисоединения, 0) КАК СтоимостьТехнологическиеПрисоединения,
            |   ЕСТЬNULL(СпецификацииНоменклатуры.СтоимостьПроектныеРаботы, 0) КАК СтоимостьПроектныеРаботы,
            |   Комплектующие.Номенклатура.Код КАК Код,
            |   Комплектующие.Номенклатура.Наименование КАК Материал,
            |   Комплектующие.Количество КАК Количество,
            |   Комплектующие.ЕдиницаИзмерения.Наименование КАК Единица,
            |   ЕСТЬNULL(Комплектующие.Цена, 0) КАК Цена,
            |   ЕСТЬNULL(Комплектующие.Сумма, 0) КАК Сумма,
            |   ЕСТЬNULL(Комплектующие.Номенклатура.НоменклатурнаяГруппа.Наименование, """") КАК НоменклатурнаяГруппа
            |ИЗ
            |   Справочник.СпецификацииНоменклатуры КАК СпецификацииНоменклатуры
            |   ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СпецификацииНоменклатуры.ИсходныеКомплектующие КАК Комплектующие
            |   ПО Комплектующие.Ссылка = СпецификацииНоменклатуры.Ссылка
            |ГДЕ
            |   " + УсловиеГде;
        
        Если Не ПустаяСтрока(КодФильтр) Тогда
            ЗапросБД.УстановитьПараметр("КодФильтр", "%" + КодФильтр + "%");
        КонецЕсли;
        Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
            ЗапросБД.УстановитьПараметр("НаименованиеФильтр", "%" + НаименованиеФильтр + "%");
        КонецЕсли;
        Если Не ПустаяСтрока(МатериалФильтр) Тогда
            ЗапросБД.УстановитьПараметр("МатериалФильтр", "%" + МатериалФильтр + "%");
        КонецЕсли;
        Если Не ПустаяСтрока(ГодФильтр) Тогда
            ГодФильтрЧисло = Число(ГодФильтр);
            Если СтрДлина(ГодФильтр) = 2 Тогда
                ГодФильтрЧисло = 2000 + ГодФильтрЧисло;
            КонецЕсли;
            Если Не ПустаяСтрока(МесяцФильтр) Тогда
                МесяцФильтрЧисло = Число(МесяцФильтр);
                ДатаНач = Дата(ГодФильтрЧисло, МесяцФильтрЧисло, 1);
                ДатаКон = КонецМесяца(ДатаНач);
            Иначе
                ДатаНач = Дата(ГодФильтрЧисло, 1, 1);
                ДатаКон = Дата(ГодФильтрЧисло, 12, 31, 23, 59, 59);
            КонецЕсли;
            ЗапросБД.УстановитьПараметр("ДатаНач", ДатаНач);
            ЗапросБД.УстановитьПараметр("ДатаКон", ДатаКон);
        КонецЕсли;
        
        МассивСпецификаций = Новый Массив;
        СпецификацииПоСсылке = Новый Соответствие;
        
        Результат = ЗапросБД.Выполнить();
        Выборка = Результат.Выбрать();
        
        Пока Выборка.Следующий() Цикл
            КлючСпецификации = Выборка.СпецификацияСсылка;
            
            Спецификация = СпецификацииПоСсылке.Получить(КлючСпецификации);
            Если Спецификация = Неопределено Тогда
                Спецификация = Новый Структура;
                Спецификация.Вставить("Код", ?(ЗначениеЗаполнено(Выборка.КодСпецификации), Строка(Выборка.КодСпецификации), ""));
                ДатаУтв = Выборка.ДатаУтвержденияСпецификации;
                Спецификация.Вставить("ДатаУтверждения", ?(ЗначениеЗаполнено(ДатаУтв), Формат(ДатаУтв, "ДФ='dd.MM.yyyy'"), ""));
                Спецификация.Вставить("Ответственный", ?(ЗначениеЗаполнено(Выборка.ОтветственныйСпецификации), Строка(Выборка.ОтветственныйСпецификации), ""));
                Спецификация.Вставить("Наименование", Строка(Выборка.Наименование));
                ДатаПоставки = ДатыПоставкиПоСсылке.Получить(КлючСпецификации);
                Если ЗначениеЗаполнено(ДатаПоставки) Тогда
                    Спецификация.Вставить("ДатаПоставки", Формат(ДатаПоставки, "ДФ='dd.MM.yyyy'"));
                Иначе
                    Спецификация.Вставить("ДатаПоставки", "");
                КонецЕсли;
                // Стоимости из шапки спецификации (безопасное приведение к числу)
                Попытка Спецификация.Вставить("СтоимостьРабот", Число(Выборка.СтоимостьРабот)); Исключение Спецификация.Вставить("СтоимостьРабот", 0); КонецПопытки;
                Попытка Спецификация.Вставить("СтоимостьТранспорт", Число(Выборка.СтоимостьТранспорт)); Исключение Спецификация.Вставить("СтоимостьТранспорт", 0); КонецПопытки;
                Попытка Спецификация.Вставить("СтоимостьНакладные", Число(Выборка.СтоимостьНакладные)); Исключение Спецификация.Вставить("СтоимостьНакладные", 0); КонецПопытки;
                Попытка Спецификация.Вставить("СтоимостьАрендаСпецТехники", Число(Выборка.СтоимостьАрендаСпецТехники)); Исключение Спецификация.Вставить("СтоимостьАрендаСпецТехники", 0); КонецПопытки;
                Попытка Спецификация.Вставить("СтоимостьТехнологическиеПрисоединения", Число(Выборка.СтоимостьТехнологическиеПрисоединения)); Исключение Спецификация.Вставить("СтоимостьТехнологическиеПрисоединения", 0); КонецПопытки;
                Попытка Спецификация.Вставить("СтоимостьПроектныеРаботы", Число(Выборка.СтоимостьПроектныеРаботы)); Исключение Спецификация.Вставить("СтоимостьПроектныеРаботы", 0); КонецПопытки;
                Спецификация.Вставить("Материалы", Новый Массив);
                МассивСпецификаций.Добавить(Спецификация);
                СпецификацииПоСсылке.Вставить(КлючСпецификации, Спецификация);
            КонецЕсли;
            
            Если ЗначениеЗаполнено(Выборка.Код) Или ЗначениеЗаполнено(Выборка.Материал) Тогда
                Комплектующее = Новый Структура;
                Комплектующее.Вставить("Код", ?(ЗначениеЗаполнено(Выборка.Код), Строка(Выборка.Код), ""));
                Комплектующее.Вставить("Материал", ?(ЗначениеЗаполнено(Выборка.Материал), Строка(Выборка.Материал), ""));
                Комплектующее.Вставить("Количество", Выборка.Количество);
                Комплектующее.Вставить("Единица", ?(ЗначениеЗаполнено(Выборка.Единица), Строка(Выборка.Единица), ""));
                // Ценовые поля материала (безопасное приведение к числу)
                Попытка
                    Комплектующее.Вставить("Цена", Число(Выборка.Цена));
                Исключение
                    Комплектующее.Вставить("Цена", 0);
                КонецПопытки;
                Попытка
                    Комплектующее.Вставить("Сумма", Число(Выборка.Сумма));
                Исключение
                    Комплектующее.Вставить("Сумма", 0);
                КонецПопытки;
                // Номенклатурная группа материала
                Комплектующее.Вставить("НоменклатурнаяГруппа", ?(ЗначениеЗаполнено(Выборка.НоменклатурнаяГруппа), Строка(Выборка.НоменклатурнаяГруппа), ""));
                
                Материалы = Спецификация["Материалы"];
                Материалы.Добавить(Комплектующее);
            КонецЕсли;
        КонецЦикла;
        
        // Подменяем массив Материалы на строку "N позиций", если не запрошен полный список (name+full)
        Если НЕ ПоказыватьПолныйСписокМатериалов Тогда
            Для Каждого Спецификация Из МассивСпецификаций Цикл
                К = Спецификация["Материалы"].Количество();
                Ост10 = К - Цел(К / 10) * 10;
                Ост100 = К - Цел(К / 100) * 100;
                Если Ост10 = 1 И Ост100 <> 11 Тогда
                    Слово = "позиция";
                ИначеЕсли (Ост10 = 2 ИЛИ Ост10 = 3 ИЛИ Ост10 = 4) И (Ост100 < 10 ИЛИ Ост100 >= 20) Тогда
                    Слово = "позиции";
                Иначе
                    Слово = "позиций";
                КонецЕсли;
                Спецификация.Вставить("Материалы", Строка(К) + " " + Слово);
            КонецЦикла;
        КонецЕсли;
        
        // 2. Сериализация в JSON
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, МассивСпецификаций);
        JSONСтрока = ЗаписьJSON.Закрыть();
        
        // 3. Формируем ответ
        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(JSONСтрока);
        Возврат Ответ;
        
    Исключение
        // Логируем ошибку для диагностики
        ТекстОшибки = "Ошибка: " + ОписаниеОшибки() + 
                     " | " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
        
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(ТекстОшибки);
        Возврат Ответ;
    КонецПопытки;
    
КонецФункции