Функция GetMaterials(Запрос)
    Попытка
        МассивНоменклатуры = Новый Массив;

        // Параметры из URL: /get/code/{code} и /get/name/{name}
        КодФильтр = "";
        НаименованиеФильтр = "";
        Попытка
            КодФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["code"]));
        Исключение
            КодФильтр = "";
        КонецПопытки;
        Попытка
            НаименованиеФильтр = СокрЛП(Строка(Запрос.ПараметрыURL["name"]));
        Исключение
            НаименованиеФильтр = "";
        КонецПопытки;

        // Условие WHERE — всегда исключаем помеченные на удаление
        УсловиеГде = "Номенклатура.ПометкаУдаления = ЛОЖЬ";
        Если Не ПустаяСтрока(КодФильтр) Тогда
            УсловиеГде = УсловиеГде + " И Номенклатура.Код ПОДОБНО &КодФильтр";
        КонецЕсли;
        Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
            УсловиеГде = УсловиеГде + " И Номенклатура.Наименование ПОДОБНО &НаименованиеФильтр";
        КонецЕсли;

        ЗапросБД = Новый Запрос;
        ЗапросБД.Текст =
            "ВЫБРАТЬ
            |   Номенклатура.Код КАК Код,
            |   Номенклатура.Наименование КАК Наименование,
            |   Номенклатура.ЭтоГруппа КАК ЭтоГруппа,
            |   Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК ЕдиницаИзмерения,
            |   Номенклатура.ВидНоменклатуры.Наименование КАК ВидНоменклатуры,
            |   Номенклатура.НоменклатурнаяГруппа.Наименование КАК НоменклатурнаяГруппа,
            |   Номенклатура.Родитель КАК Родитель
            |ИЗ
            |   Справочник.Номенклатура КАК Номенклатура
            |ГДЕ
            |   " + УсловиеГде + "
            |УПОРЯДОЧИТЬ ПО
            |   Номенклатура.Наименование";

        Если Не ПустаяСтрока(КодФильтр) Тогда
            ЗапросБД.УстановитьПараметр("КодФильтр", "%" + КодФильтр + "%");
        КонецЕсли;
        Если Не ПустаяСтрока(НаименованиеФильтр) Тогда
            ЗапросБД.УстановитьПараметр("НаименованиеФильтр", "%" + НаименованиеФильтр + "%");
        КонецЕсли;

        Результат = ЗапросБД.Выполнить();
        Выборка = Результат.Выбрать();

        Пока Выборка.Следующий() Цикл
            Материал = Новый Структура;
            Материал.Вставить("Код",                  СокрЛП(Строка(Выборка.Код)));
            Материал.Вставить("Наименование",          СокрЛП(Строка(Выборка.Наименование)));
            Материал.Вставить("ЭтоГруппа",             Выборка.ЭтоГруппа);
            Материал.Вставить("ЕдиницаИзмерения",      СокрЛП(Строка(Выборка.ЕдиницаИзмерения)));
            Материал.Вставить("ВидНоменклатуры",        СокрЛП(Строка(Выборка.ВидНоменклатуры)));
            Материал.Вставить("НоменклатурнаяГруппа",   СокрЛП(Строка(Выборка.НоменклатурнаяГруппа)));

            // Полная иерархия: от корня к непосредственному родителю
            МассивИерархии = Новый Массив;
            ТекущийРодитель = Выборка.Родитель;
            Пока ЗначениеЗаполнено(ТекущийРодитель) Цикл
                Группа = Новый Структура;
                Группа.Вставить("Код",          СокрЛП(Строка(ТекущийРодитель.Код)));
                Группа.Вставить("Наименование",  СокрЛП(Строка(ТекущийРодитель.Наименование)));
                МассивИерархии.Вставить(0, Группа); // Вставляем в начало — корень будет первым
                ТекущийРодитель = ТекущийРодитель.Родитель;
            КонецЦикла;
            Материал.Вставить("Иерархия", МассивИерархии);

            МассивНоменклатуры.Добавить(Материал);
        КонецЦикла;

        JSON = Новый ЗаписьJSON;
        JSON.УстановитьСтроку();
        ЗаписатьJSON(JSON, МассивНоменклатуры);
        JSONСтрока = JSON.Закрыть();

        Ответ = Новый HTTPСервисОтвет(200);
        Ответ.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(JSONСтрока);
        Возврат Ответ;
    Исключение
        ИнформацияОбОшибке = ИнформацияОбОшибке();
        ТекстОшибки = "Описание: " + ОписаниеОшибки()
            + Символы.ПС + "Подробно: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке);
        Ответ = Новый HTTPСервисОтвет(500);
        Ответ.Заголовки.Вставить("Content-Type", "text/plain; charset=utf-8");
        Ответ.УстановитьТелоИзСтроки(ТекстОшибки);
        Возврат Ответ;
    КонецПопытки;
КонецФункции
