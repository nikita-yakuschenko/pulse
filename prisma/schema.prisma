// Prisma schema for Модуль.Пульс
// Better Auth models + first phase entities
// Prisma 7: url/directUrl в prisma.config.ts; клиент через adapter в PrismaClient.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  schemas  = ["public", "auth"]
}

// Better Auth models
model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  sessions      Session[]
  accounts      Account[]

  @@unique([email])
  @@schema("public")
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@schema("public")
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@schema("public")
  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@schema("public")
  @@map("verification")
}

model MfaCode {
  id        String   @id @default(cuid())
  userId    String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@schema("public")
  @@map("mfa_code")
}

// First phase entities
model Plan {
  id        String   @id @default(cuid())
  title     String
  type      String   // production | installation
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
  @@map("plan")
}

model Specification {
  id        String   @id @default(cuid())
  name      String
  externalId String? // 1C reference
  data      Json?    // specification content
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
  @@map("specification")
}

model Balance {
  id           String   @id @default(cuid())
  warehouseId  String
  itemId       String
  quantity     Decimal
  externalId   String?  // 1C reference
  syncedAt     DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@schema("public")
  @@map("balance")
}

model Warehouse {
  id        String   @id @default(cuid())
  name      String
  externalId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
  @@map("warehouse")
}

model Supplier {
  id        String   @id @default(cuid())
  name      String
  externalId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sorders   Sorder[]

  @@schema("public")
  @@map("supplier")
}

model Sorder {
  id         String   @id @default(cuid())
  supplierId String
  status     String
  data       Json?
  externalId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  @@schema("public")
  @@map("sorder")
}

model Payment {
  id         String   @id @default(cuid())
  status     String
  amount     Decimal?
  data       Json?
  externalId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@schema("public")
  @@map("payment")
}

model ReorderPoint {
  id               String   @id @default(cuid())
  itemCode         String   // Для одиночных: код номенклатуры; для групповых: пустая строка
  itemName         String   // Для одиночных: имя материала; для групповых: пользовательское имя
  reorderQuantity  Decimal  // Точка заказа (минимальное количество)
  unit             String?  // Единица измерения
  isGroup          Boolean  @default(false) // Групповая точка заказа (несколько материалов)
  itemCodes        Json?    // Для групповых: массив кодов материалов ["code1", "code2", ...]
  warehouseCodes   Json?    // Коды складов для отслеживания ["code1", "code2", ...]; null = все склады (для обратной совместимости)
  userId           String   // ID пользователя из Supabase Auth (без FK)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@schema("public")
  @@map("reorder_point")
}

// Настройки отображения групп номенклатуры по пользователю (избранное, скрытие)
// section: "balance" | "nomenclature" — настройки независимы для каждого раздела
model MaterialGroupPreference {
  id        String   @id @default(cuid())
  userId    String   // ID пользователя (Supabase Auth)
  groupCode String   // Код группы из дерева номенклатуры 1С
  section   String   @default("balance") // "balance" | "nomenclature"
  favorite  Boolean  @default(false)
  hidden    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, groupCode, section])
  @@schema("public")
  @@map("material_group_preference")
}

// Избранные материалы по пользователю (отображаются вверху списка при провале в группу)
// section: "balance" | "nomenclature" — настройки независимы для каждого раздела
model MaterialPreference {
  id           String   @id @default(cuid())
  userId       String   // ID пользователя (Supabase Auth)
  materialCode String   // Код номенклатуры из дерева 1С
  section      String   @default("balance") // "balance" | "nomenclature"
  favorite     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, materialCode, section])
  @@schema("public")
  @@map("material_preference")
}

// Исключения из поиска: группы верхнего уровня, которые не участвуют в поиске
// Привязка к юзеру и разделу
model SearchExclusion {
  id        String   @id @default(cuid())
  userId    String   // ID пользователя (Supabase Auth)
  groupCode String   // Код группы верхнего уровня
  section   String   @default("nomenclature") // "balance" | "nomenclature"
  createdAt DateTime @default(now())

  @@unique([userId, groupCode, section])
  @@schema("public")
  @@map("search_exclusion")
}

// MRP-отчёт: потребность из спецификаций + остатки → объём закупки
model MrpReport {
  id        String   @id @default(cuid())
  title     String?  // Название отчёта (опционально)
  userId    String   // ID пользователя (Supabase Auth)
  status    String   @default("draft") // "draft" | "computed"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  specifications MrpReportSpecification[]
  results        MrpReportResult[]

  @@schema("public")
  @@map("mrp_report")
}

// Спецификации, включённые в отчёт (код из 1С)
model MrpReportSpecification {
  id                 String    @id @default(cuid())
  reportId           String
  specificationCode  String    // Код спецификации в 1С
  specificationName  String?   // Наименование для отображения
  report             MrpReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@schema("public")
  @@map("mrp_report_specification")
}

// Итоговая строка расчёта: потребность, остаток, к закупке (снимок на момент расчёта)
model MrpReportResult {
  id                String    @id @default(cuid())
  reportId          String
  materialCode      String
  materialName      String
  unit              String?
  nomenclatureGroup String?  // Номенклатурная группа из ответа спецификаций (Материалы[].НоменклатурнаяГруппа)
  demandQty         Decimal   // Потребность (сумма по спецификациям)
  balanceQty        Decimal   // Остаток на складе на момент расчёта
  purchaseQty       Decimal   // К закупке = max(0, потребность - остаток)
  report            MrpReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@schema("public")
  @@map("mrp_report_result")
}

// --- График монтажа (Строительная часть) ---

// Структурированный адрес (DaData / ручной ввод). Чтение по address_id из БД, без повторных вызовов DaData.
model Address {
  id        String   @id @default(cuid())
  region    String?
  district  String?
  locality  String?
  street    String?
  house     String?
  fullText  String?
  kladrCode String?
  fiasId    String?
  isCustom  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contracts           Contract[]
  constructionObjects ConstructionObject[]
  mountScheduleEntries MountScheduleEntry[]

  @@schema("public")
  @@map("address")
}

// Объект строительства (создаётся в разделе Объекты; опорная дата — contractStartDate)
model ConstructionObject {
  id                  String    @id @default(cuid())
  addressId           String?
  contractId          String?
  contractNumber      String
  kitNo               Int?   // Номер домокомплекта (комплекта)
  buildType           String?
  projectId           String?
  projectName         String?
  foremanId           String?
  foremanName         String?
  amountCurrent       Decimal?
  amountNext          Decimal?
  contractStartDate   DateTime? // Дата начала строительства (старта по договору)
  comment             String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  address  Address?   @relation(fields: [addressId], references: [id], onDelete: SetNull)
  contract Contract?   @relation(fields: [contractId], references: [id], onDelete: SetNull)
  project  ProjectCatalog? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  foreman  Employee?  @relation(fields: [foremanId], references: [id], onDelete: SetNull)
  mountScheduleEntries MountScheduleEntry[]

  @@schema("public")
  @@map("construction_object")
}

// Прорабы (foreman)
model Employee {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contracts           Contract[]
  constructionObjects ConstructionObject[]
  mountScheduleEntries MountScheduleEntry[]

  @@schema("public")
  @@map("employee")
}

// Типовые проекты домов
model ProjectCatalog {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contracts           Contract[]
  constructionObjects ConstructionObject[]
  mountScheduleEntries MountScheduleEntry[]

  @@schema("public")
  @@map("project_catalog")
}

// Договоры/сделки (для автозаполнения в графике монтажа)
model Contract {
  id             String    @id @default(cuid())
  contractNumber String
  kitNo          Int?      // Номер домокомплекта
  addressId      String?
  buildType      String?
  projectId      String?
  foremanId      String?
  amount         Decimal?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  address  Address?       @relation(fields: [addressId], references: [id], onDelete: SetNull)
  project  ProjectCatalog? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  foreman  Employee?      @relation(fields: [foremanId], references: [id], onDelete: SetNull)
  constructionObjects ConstructionObject[]
  mountScheduleEntries MountScheduleEntry[]

  @@schema("public")
  @@map("contract")
}

// Запись графика монтажа (одна строка = объект/дом)
model MountScheduleEntry {
  id                      String    @id @default(cuid())
  objectId                String?   // Ссылка на объект из раздела Объекты (опционально для обратной совместимости)
  planMonth               DateTime  // Первое число месяца
  contractId              String?
  contractNumber          String
  kitNo                   Int?   // Номер домокомплекта
  addressId               String?
  buildType               String?
  projectId               String?
  projectName             String?
  foremanId               String?
  foremanName             String?
  amountCurrent           Decimal?
  amountNext              Decimal?
  stage                   String?
  escrowEgrnStatus        String?
  productionStatus        String?
  statusSummaryOverride   String?
  productionLaunchDate    DateTime?
  productionNote          String?
  pilesDate               DateTime?
  pilesRaw                String?
  shipmentDate            DateTime?
  shipmentRaw             String?
  windowsRaw              String?
  windowsInstallRaw       String?
  roofRaw                 String?
  roofWorkDate            DateTime?
  roofWorkRaw             String?
  electricRaw             String?
  plumbingRaw             String?
  screedRaw               String?
  exteriorRaw             String?
  handoverDate            DateTime?
  handoverRaw             String?
  mountStartDate          DateTime?  // Утверждённая дата начала монтажа — при наличии запись в табе «График монтажа»
  comment                 String?
  sortOrder               Int?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  object   ConstructionObject? @relation(fields: [objectId], references: [id], onDelete: SetNull)
  contract Contract?  @relation(fields: [contractId], references: [id], onDelete: SetNull)
  address  Address?  @relation(fields: [addressId], references: [id], onDelete: SetNull)
  project  ProjectCatalog? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  foreman  Employee?  @relation(fields: [foremanId], references: [id], onDelete: SetNull)

  @@schema("public")
  @@map("mount_schedule_entry")
}
